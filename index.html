<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Code Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Code Playground">
<meta property="og:url" content="http://blog.codeplayground.org/index.html">
<meta property="og:site_name" content="Code Playground">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code Playground">
  
    <link rel="alternative" href="/atom.xml" title="Code Playground" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-3286820-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Code Playground</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Learning something daily</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Building-a-basic-REST-AspNet-Core-Example-Part-4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/14/Building-a-basic-REST-AspNet-Core-Example-Part-4/" class="article-date">
  <time datetime="2016-12-14T08:48:22.000Z" itemprop="datePublished">Dec 14 2016</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/14/Building-a-basic-REST-AspNet-Core-Example-Part-4/">Building a basic REST AspNet Core Example - Part 4</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you need to catch up on the previous posts then see <a href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/" title="part 1">part 1</a> &amp; <a href="/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/" title="2">2</a>, <a href="/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/" title="3">3</a>. The source code for this post is at <a href="https://github.com/mikael-kuhn/basic-rest/tree/master/4_Invoice_Api" target="_blank" rel="external">github</a>.</p>
<p>Here we are going to take a look at how to tackle the GET /invoices call. I’ll repeat the disclamer - It is going to be pretty naive and basic and I will build on it in further posts (hopefully). We are still at level 2 in <a href="http://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank" rel="external">Richardson’s maturity model</a> and will not take hypermedia in just yet. We will not even reach a full GET implementation in this post.</p>
<h2 id="GET-invoices-with-HTTP-Prefer-Header"><a href="#GET-invoices-with-HTTP-Prefer-Header" class="headerlink" title="GET invoices/ with HTTP Prefer Header"></a>GET invoices/ with HTTP Prefer Header</h2><p>One of the first things that we will have to think about is what resource representation we want. Now we could say we want to return the complete invoices, or we could say we do not want to return lines. Let’s start with the simplest case. We return a list with the full representation.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[HttpGet]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> invoices = invoiceRepository.GetAll().Select(</div><div class="line">        invoice =&gt; getInvoiceMapper.ToModel(invoice));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Ok(invoices);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>but in many cases that may not be what our client is interested in. We could probably cut the invoice lines. There are many ways in “the wild”, but here we are going to look at the <a href="https://tools.ietf.org/html/rfc7240" target="_blank" rel="external">HTTP Prefer Header in RFC 7240</a> as a way to tell the server how we prefer the response. To shortly introduce Prefer, the RFC says:</p>
<blockquote>
<p>The Prefer request header field is used to indicate that particular server behaviors are preferred by the client but are not required for successful completion of the request.  Prefer is similar in nature to the Expect header field defined by Section 6.1.2 of [RFC7231] with the exception that servers are allowed to ignore stated preferences.</p>
</blockquote>
<p>Section 4.2 specifies </p>
<blockquote>
<p>The “return=representation” preference indicates that the client prefers that the server include an entity representing the current state of the resource in the response to a successful request.</p>
<p>The “return=minimal” preference, on the other hand, indicates that the client wishes the server to return only a minimal response to a successful request</p>
</blockquote>
<p>which is just what we need here. So we want to be able to handle the following requests:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GET /invoices HTTP/1.1</div><div class="line">Prefer: return=representation</div><div class="line"></div><div class="line">GET /invoices HTTP/1.1</div><div class="line">Prefer: return=minimal</div></pre></td></tr></table></figure>
<p>and the response should state which prefer’s we have handled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Preference-Applied: return=representation</div></pre></td></tr></table></figure>
<p>You can also take a look at the parameters that IANA keeps a list of <a href="http://www.iana.org/assignments/http-parameters/http-parameters.xhtml" target="_blank" rel="external">here</a>. But actually we are also required to return the <a href="https://tools.ietf.org/html/rfc7231#section-7.1.4" target="_blank" rel="external">Vary Header</a> so that we do not mess up the HTTP infrastructure like shown here</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Date: Wed, 14 Dec 2016 12:08:04 GMT</div><div class="line">Content-Type: application/vnd.restexample.finance+json; charset=utf-8</div><div class="line">Vary: Prefer,Accept,Accept-Encoding</div><div class="line">Preference-Applied: return=representation</div></pre></td></tr></table></figure>
<p>Here’s the implementation<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[HttpGet]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> preferHeader = Request.Headers.Prefer();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (SupportedRepresentations.Contains(preferHeader.Return))</div><div class="line">    &#123;</div><div class="line">        Response.Headers.Add(<span class="string">"Preference-Applied"</span>, <span class="string">"return="</span> + preferHeader.Return);</div><div class="line">        Response.Headers.Add(<span class="string">"Vary"</span>, VaryHeaderValue);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> invoices = invoiceRepository.GetAll();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (preferHeader.Return == ReturnMinimal)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Ok(invoices.Select(invoice =&gt; getMinimalInvoiceMapper.ToModel(invoice)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Ok(invoices.Select(invoice =&gt; getInvoiceMapper.ToModel(invoice)));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>We use a helper method to get the prefer header. If the representation asked for can be fullfilled then we return the required headers. If representation=minimal is specified then we return a list of invoices that has a minimal model as specified here</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetMinimalInvoice</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset InvoiceDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset DueDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> GetInvoiceCustomer Customer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> SubTotal &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h2><p>That concludes the first view on the GET invoices/.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2016/12/14/Building-a-basic-REST-AspNet-Core-Example-Part-4/" data-id="ciwop53bs000047aacjw2mqzs" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2016/12/14/Building-a-basic-REST-AspNet-Core-Example-Part-4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AspNet-Mvc/">AspNet Mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/REST/">REST</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-basic-REST-aspnet-core-example-Part-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/" class="article-date">
  <time datetime="2016-12-12T12:04:13.000Z" itemprop="datePublished">Dec 12 2016</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/">Building a basic REST AspNet Core Example - Part 3 </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In the previous <a href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/" title="part 1">part 1</a> &amp; <a href="/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/" title="2">2</a> we build an invoices controller with support for POST/PUT/GET/PATCH http methods. In this one we will add HTTP HEAD method and ETag support  - I’ll repeat the disclamer - It is going to be pretty naive and basic, but I will add to it in future posts (hopefully). The source code for this post is at <a href="https://github.com/mikael-kuhn/basic-rest/tree/master/3_Invoice_Api" target="_blank" rel="external">github</a>.</p>
<h2 id="Adding-HTTP-HEAD-support"><a href="#Adding-HTTP-HEAD-support" class="headerlink" title="Adding HTTP HEAD support"></a>Adding HTTP HEAD support</h2><p>You can read about the HEAD verb in the <a href="https://tools.ietf.org/html/rfc7231#section-4.3.2" target="_blank" rel="external">HTTP protocol</a>. But the part we are interested in is</p>
<blockquote>
<p>The HEAD method is identical to GET except that the server MUST NOT send a message body in the response (i.e., the response terminates at the end of the header section).  The server SHOULD send the same header fields in response to a HEAD request as it would have sent if the request had been a GET, except that the payload header fields MAY be omitted</p>
</blockquote>
<p>The verb is useful for existence checking, validation that you have the latest version etc. Here we will use it for existance checking to start with. We will omit the Content-Length header since it is allowed to do so, and our use case does not rely on it.</p>
<p>So let’s add a minimum implementation to the InvoicesController</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[HttpHead(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">HeadForInvoice</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">&#123;</div><div class="line">    Response.ContentType = ApiDefinition.ApiMediaType;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!invoiceRepository.Exists(id))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Ok();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We’d still like to return the Content-Type so thus we set it on the response. </p>
<p>The solution is still only at <a href="http://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank" rel="external">richardson’s maturity model</a> level 2. And we can do better in multiple areas.</p>
<h2 id="ETag-If-match-If-none-match"><a href="#ETag-If-match-If-none-match" class="headerlink" title="ETag, If-match, If-none-match"></a>ETag, If-match, If-none-match</h2><p>Until now we have not really cared if our PUT call tries to update something even though it may have a stale view of the resource. The <a href="https://tools.ietf.org/html/rfc7232#section-2.3" target="_blank" rel="external">ETag header</a> can help us here. We can specify the current entity version on GET response with an ETag header. When we do a PUT we can then specify the “If-match” header with the ETag. Thus we will only update the resource if the ETag matches. But to use the ETag we would want to use it on most Http verbs. The example below uses the invoice version as the ETag - in principle this should have been an “opaque” value instead.</p>
<h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><p>We should return an ETag in the response when a GET request is made. It could be done like this (somewhat clumpsy)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[HttpGet(<span class="string">"&#123;id&#125;"</span>, Name = <span class="string">"GetInvoice"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> invoice = invoiceRepository.Get(id);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (invoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;invoice.Version&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Ok(getInvoiceMapper.ToModel(invoice));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Please note the invoice has been extended with a Version property that is changed when the update method of the repository is called.</p>
<p>So now when we make a request the response headers can look like this</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Date: Mon, <span class="number">12</span> Dec <span class="number">2016</span> <span class="number">16</span>:<span class="number">21</span>:<span class="number">21</span> GMT</div><div class="line">Transfer-Encoding: chunked</div><div class="line">Content-Type: application/vnd.restexample.finance+json; charset=utf<span class="number">-8</span></div><div class="line">ETag: <span class="string">"e90baf01-40ce-4f46-89ea-227bb32fc421"</span></div><div class="line">Server: Kestrel</div></pre></td></tr></table></figure>
<p>We should also be able to handle the ETag if specified in the request. It will make sense to implement support for If-none-match header. We will return a new entity if the ETag does not match the current version of the invoice. If it matches we will return HTTP Not Modified.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[HttpGet(<span class="string">"&#123;id&#125;"</span>, Name = <span class="string">"GetInvoice"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> invoice = invoiceRepository.Get(id);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (invoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> currentETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;invoice.Version&#125;</span>\""</span>);</div><div class="line">    <span class="keyword">if</span> (IfMatchGivenIfNoneMatch(currentETag))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> StatusCode((<span class="keyword">int</span>)HttpStatusCode.NotModified);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = currentETag;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Ok(getInvoiceMapper.ToModel(invoice));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">IfMatchGivenIfNoneMatch</span>(<span class="params">EntityTagHeaderValue currentETag</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> requestHeaders = Request.GetTypedHeaders();</div><div class="line">    <span class="keyword">return</span> requestHeaders.IfNoneMatch != <span class="literal">null</span> &amp;&amp;</div><div class="line">           requestHeaders.IfNoneMatch.Contains(currentETag);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So now we can add the If-None-Match header to our request like this</p>
<p>If-None-Match: “e90baf01-40ce-4f46-89ea-227bb32fc421”</p>
<p>and if it is current we get these response headers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 304 Not Modified</div><div class="line">Date: Mon, 12 Dec 2016 17:28:02 GMT</div><div class="line">Server: Kestrel</div></pre></td></tr></table></figure>
<h3 id="PUT-PATCH"><a href="#PUT-PATCH" class="headerlink" title="PUT/PATCH"></a>PUT/PATCH</h3><p>Here we are going to return HTTP status Precondition Failed (415) if an ETag is provided and it does not match. The request should have the If-Match header added to it. Here is PUT</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">[HttpPut(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Put</span>(<span class="params"><span class="keyword">string</span> id, [FromBody] UpdateInvoice updateInvoice</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (updateInvoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!invoiceRepository.Exists(id))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (IfMatchIsInvalid(invoiceRepository.GetCurrentVersion(id)))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> StatusCode((<span class="keyword">int</span>) HttpStatusCode.PreconditionFailed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> newVersion = invoiceRepository.Update(updateInvoiceMapper.ToDomain(</div><div class="line">        updateInvoice, id)).Value;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;newVersion&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">IfMatchIsInvalid</span>(<span class="params"><span class="keyword">string</span> currentVersion</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> requestHeaders = Request.GetTypedHeaders();</div><div class="line">    <span class="keyword">var</span> currentETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;currentVersion&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> requestHeaders.IfMatch != <span class="literal">null</span> &amp;&amp;</div><div class="line">           !requestHeaders.IfMatch.Any(ifm =&gt; ifm.Equals(EntityTagHeaderValue.Any))</div><div class="line">           &amp;&amp; !requestHeaders.IfMatch.Contains(currentETag);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The ETag can be specified as * thus we also check against EntityTagHeaderValue.Any.</p>
<p>We do the same for PATCH</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[HttpPatch(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Patch</span>(<span class="params"><span class="keyword">string</span> id, [FromBody] JsonPatchDocument&lt;UpdateInvoice&gt; patchDocument</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (patchDocument == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> invoice = invoiceRepository.Get(id);</div><div class="line">    <span class="keyword">if</span> (invoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (IfMatchIsInvalid(invoice.Version))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> StatusCode((<span class="keyword">int</span>) HttpStatusCode.PreconditionFailed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> updateInvoice = updateInvoiceMapper.ToModel(invoice);</div><div class="line">    patchDocument.ApplyTo(updateInvoice, ModelState);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> updatedDomainInvoice = updateInvoiceMapper.ToDomain(updateInvoice, id);</div><div class="line">    <span class="keyword">var</span> newVersion = invoiceRepository.Update(updatedDomainInvoice);</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;newVersion&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h3><p>HEAD should behave like GET so we can take that logic<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[HttpHead(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">HeadForInvoice</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">&#123;</div><div class="line">    Response.ContentType = ApiDefinition.ApiMediaType;</div><div class="line">    Response.GetTypedHeaders();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!invoiceRepository.Exists(id))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> currentVersion = invoiceRepository.GetCurrentVersion(id);</div><div class="line">    <span class="keyword">var</span> currentETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;currentVersion&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (IfMatchGivenIfNoneMatch(currentETag))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> StatusCode((<span class="keyword">int</span>)HttpStatusCode.NotModified);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = currentETag;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Ok();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><p>POST should return an ETag</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[HttpPost]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Post</span>(<span class="params">[FromBody] UpdateInvoice updateInvoice</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (updateInvoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> createdInvoice = invoiceRepository.Create(updateInvoiceMapper.ToDomain(updateInvoice));</div><div class="line"></div><div class="line">    <span class="keyword">var</span> responseHeaders = Response.GetTypedHeaders();</div><div class="line">    responseHeaders.ETag = <span class="keyword">new</span> EntityTagHeaderValue(<span class="string">$"\"<span class="subst">&#123;createdInvoice.Version&#125;</span>\""</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> CreatedAtRoute(<span class="string">"GetInvoice"</span>,</div><div class="line">        <span class="keyword">new</span> &#123; id = createdInvoice.Id &#125;,</div><div class="line">        getInvoiceMapper.ToModel(createdInvoice));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h2><p>That is it for the most basic api for now. But we can do more as we will see in later posts (hopefully).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/" data-id="ciwop53bw000147aab3i2p347" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AspNet-Mvc/">AspNet Mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/REST/">REST</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-basic-REST-aspnet-core-example-Part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/" class="article-date">
  <time datetime="2016-12-09T09:18:40.000Z" itemprop="datePublished">Dec 9 2016</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/">Building a basic REST AspNet Core Example - Part 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In the last <a href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/" title="post">post</a> we made the first step at a REST Api. In this post we will improve it by adding HTTP PATCH/OPTIONS support. I’ll repeat the disclamer - It is going to be pretty naive and basic, but I will add to it in future posts (hopefully). The source code for this post is <a href="https://github.com/mikael-kuhn/basic-rest/tree/master/2_Invoice_Api" target="_blank" rel="external">here</a>.</p>
<h2 id="Adding-HTTP-PATCH-support"><a href="#Adding-HTTP-PATCH-support" class="headerlink" title="Adding HTTP PATCH support"></a>Adding HTTP PATCH support</h2><p>With PUT we have to supply the complete invoice in order to update it. That may not be what you want, so <a href="https://tools.ietf.org/html/rfc5789" target="_blank" rel="external">HTTP PATCH (rfc5789)</a> can help us here by allowing partial resource modification.</p>
<blockquote>
<p>The PATCH method requests that a set of changes described in the<br>request entity be applied to the resource identified by the Request-<br>URI.  The set of changes is represented in a format called a “patch<br>document” identified by a media type</p>
</blockquote>
<p>For JSON in .NET core this is implemented using <a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="external">JavaScript Object Notation (JSON) Patch</a>. The media type is “application/json-patch+json”. From Json Patch you can read</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">A JSON Patch document is a JSON [RFC4627] document that represents an</div><div class="line">array of objects.  Each object represents a single operation to be</div><div class="line">applied to the target JSON document.</div><div class="line"></div><div class="line">The following is an example JSON Patch document, transferred in a HTTP PATCH request:</div><div class="line"></div><div class="line">PATCH /my/data HTTP/1.1</div><div class="line">Host: example.org</div><div class="line">Content-Length: 326</div><div class="line">Content-Type: application/json-patch+json</div><div class="line">If-Match: &quot;abc123&quot;</div><div class="line"></div><div class="line">[</div><div class="line"> &#123; &quot;op&quot;: &quot;test&quot;, &quot;path&quot;: &quot;/a/b/c&quot;, &quot;value&quot;: &quot;foo&quot; &#125;,</div><div class="line"> &#123; &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/a/b/c&quot; &#125;,</div><div class="line"> &#123; &quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/a/b/c&quot;, &quot;value&quot;: [ &quot;foo&quot;, &quot;bar&quot; ] &#125;,</div><div class="line"> &#123; &quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/a/b/c&quot;, &quot;value&quot;: 42 &#125;,</div><div class="line"> &#123; &quot;op&quot;: &quot;move&quot;, &quot;from&quot;: &quot;/a/b/c&quot;, &quot;path&quot;: &quot;/a/b/d&quot; &#125;,</div><div class="line"> &#123; &quot;op&quot;: &quot;copy&quot;, &quot;from&quot;: &quot;/a/b/d&quot;, &quot;path&quot;: &quot;/a/b/e&quot; &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>So { “op”: “replace”, “path”: “/a/b/c”, “value”: 42 } tells us that the operation should replace the target value with 42. The path is a <a href="https://tools.ietf.org/html/rfc6901" target="_blank" rel="external">JSON Pointer</a>. If you want to take a look at the aspnet source code then look <a href="https://github.com/aspnet/JsonPatch" target="_blank" rel="external">here</a>. From the unit test you can also see that the “test” operation is not supported.</p>
<p>So let us extend our InvoicesController</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[HttpPatch(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Patch</span>(<span class="params"><span class="keyword">string</span> id, [FromBody] JsonPatchDocument&lt;UpdateInvoice&gt; patchDocument</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (patchDocument == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> invoice = invoiceRepository.Get(id);</div><div class="line">    <span class="keyword">if</span> (invoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> updateInvoice = updateInvoiceMapper.ToModel(invoice);</div><div class="line">    patchDocument.ApplyTo(updateInvoice, ModelState);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> updatedDomainInvoice = updateInvoiceMapper.ToDomain(updateInvoice, id);</div><div class="line">    invoiceRepository.Update(updatedDomainInvoice);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In the method our input is now JsonPatchDocument<updateinvoice> meaning it is an UpdateInvoice model we perform the operations on. Again we start out with a validation if the input is malformed. Next we handle the case where the invoice is not found. Since we perform the operations against an instance of UpdateInvoice here, then we must construct that instance first from the domain model. So ToModel transforms the loaded entity to our model representation. Then the patch operations are applied using patchDocument.ApplyTo. We also pass in the ModelState so that the validation will still kick in. After ApplyTo we check the ModelState. Last step it to update the invoice using the repository.</updateinvoice></p>
<h2 id="HTTP-Options"><a href="#HTTP-Options" class="headerlink" title="HTTP Options"></a>HTTP Options</h2><p>To provide a more complete REST Api we can choose to implement the HTTP OPTIONS verb.</p>
<blockquote>
<p>The OPTIONS method represents a request for information about the communication options available on the request/response chain identified by the Request-URI. This method allows the client to determine the options and/or requirements associated with a resource, or the capabilities of a server, without implying a resource action or initiating a resource retrieval. </p>
</blockquote>
<p>Using it we can determine which other Http Verbs that are available at a given uri. We can use this to eg. remove Http Put/Patch methods when no instance exists. The methods that are available should be specified in the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.7" target="_blank" rel="external">allow header</a></p>
<p>Allow: GET, POST, PUT</p>
<p>So let’s add the first OPTIONS method for the /invoices uri</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[HttpOptions]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Options</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    Response.Headers.Add(<span class="string">"Allow"</span>, <span class="keyword">string</span>.Join(<span class="string">","</span>, HttpVerbs.Options, HttpVerbs.Post));</div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now when we make a OPTIONS request we get</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 204 No Content</div><div class="line">Date: Mon, 12 Dec 2016 10:22:07 GMT</div><div class="line">Allow: OPTIONS,POST</div></pre></td></tr></table></figure>
<p>basically saying all we can do is create a new invoice.</p>
<p>When we call HTTP OPTIONS on an invoice we should return OPTIONS,GET,PUT,PATCH if the invoice exists. If not then “OPTIONS, GET”. I include GET since it can return a 404 as the response.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[HttpOptions(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">OptionsForInvoice</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!invoiceRepository.Exists(id))</div><div class="line">    &#123;</div><div class="line">        Response.Headers.Add(<span class="string">"Allow"</span>, <span class="keyword">string</span>.Join(<span class="string">","</span>,</div><div class="line">            HttpVerbs.Options,</div><div class="line">            HttpVerbs.Get));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        Response.Headers.Add(<span class="string">"Allow"</span>, <span class="keyword">string</span>.Join(<span class="string">","</span>,</div><div class="line">            HttpVerbs.Options,</div><div class="line">            HttpVerbs.Get,</div><div class="line">            HttpVerbs.Put,</div><div class="line">            HttpVerbs.Patch));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap up"></a>Wrap up</h2><p>That’s it for this time, but we are still not there so other posts will follow.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/" data-id="ciwop53bx000247aaew34jugq" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AspNet-Mvc/">AspNet Mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/REST/">REST</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-basic-REST-aspnet-core-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/" class="article-date">
  <time datetime="2016-12-08T18:48:17.000Z" itemprop="datePublished">Dec 8 2016</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/">Building a basic REST AspNet Core Example - Part 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In this post we will start on an app that exposes a REST web api for an invoice. Disclaimer - It is going to be pretty naive and basic, but I will add to it in further posts (hopefully). So actually we will for now go no higher in <a href="http://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank" rel="external">richardson’s maturity model</a> than level 2. </p>
<p>My inspiration for this blog is attending <a href="http://www.skillsmatter.co.uk" target="_blank" rel="external">skillsmatters</a> “Fast-Track to RESTful Microservices” course with Jim Webber. It is highly based on the book <a href="https://www.amazon.com/REST-Practice-Hypermedia-Systems-Architecture/dp/0596805829/ref=sr_1_1?ie=UTF8&amp;qid=1481025806&amp;sr=8-1&amp;keywords=rest+in+practice" target="_blank" rel="external">REST in Practice: Hypermedia and Systems Architecture</a>. Although the book is now old it still contains good information (code examples are naturally outdated) - so read it if you need extensive REST information, but can live with not all is up to date.</p>
<p>The case here is creating, updating and getting an invoice along the lines of these user stories. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">As a &lt;business user&gt; </div><div class="line">I want &lt;to be able to create an invoice for a customer&gt;</div><div class="line">So that &lt;we can facilitate sales&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">As a &lt;business user&gt; </div><div class="line">I want &lt;to be able to update an invoice&gt;</div><div class="line">So that &lt;it can be created in steps&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">As a &lt;business user&gt; </div><div class="line">I want &lt;to be able to view the invoice&gt;</div><div class="line">So that &lt;I can answer questions related to it&gt;</div></pre></td></tr></table></figure>
<p>Getting a list of invoices, searching etc is too advanced for now.</p>
<p>The server code will be .NET core aspnet web api (and for the fun I’m developing on ubuntu with Jetbrains Rider). It will be without a real database backing it for now - since the focus is mostly on the REST part. It does take a pretty naive approach on design of the API, but hopefully I will get to a post where this part is evolved.</p>
<p>You can find the code discussed at <a href="https://github.com/mikael-kuhn/basic-rest/tree/master/1_Invoice_Api" target="_blank" rel="external">github</a> in the 1_InvoiceApi folder.</p>
<h2 id="The-Domain"><a href="#The-Domain" class="headerlink" title="The Domain"></a>The Domain</h2><p>We will call our bounded context finance, and the primary class will be the invoice. We will start with this naive definition</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Finance.Domain.Domain</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">Invoice</span></div><div class="line">    &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Invoice</span>(<span class="params"><span class="keyword">string</span> id, DateTimeOffset invoiceDate,</span></span></div><div class="line">            DateTimeOffset dueDate,</div><div class="line">            InvoiceCustomer invoiceCustomer,</div><div class="line">            IEnumerable&lt;InvoiceLine&gt; lines)</div><div class="line">        &#123;</div><div class="line">            InvoiceDate = invoiceDate;</div><div class="line">            DueDate = dueDate;</div><div class="line">            Customer = invoiceCustomer;</div><div class="line">            Lines = lines;</div><div class="line">            Id = id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">        <span class="keyword">public</span> DateTimeOffset InvoiceDate &#123; <span class="keyword">get</span>; &#125;</div><div class="line">        <span class="keyword">public</span> DateTimeOffset DueDate &#123; <span class="keyword">get</span>; &#125;</div><div class="line">        <span class="keyword">public</span> InvoiceCustomer Customer &#123; <span class="keyword">get</span>; &#125;</div><div class="line">        <span class="keyword">public</span> IEnumerable&lt;InvoiceLine&gt; Lines &#123; <span class="keyword">get</span>; &#125;</div><div class="line">		<span class="keyword">public</span> Amount SubTotal =&gt; <span class="keyword">new</span> Amount(Lines.Sum(l =&gt; l.Total.Value));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The customer and lines are not important for understanding at present time.</p>
<h2 id="The-repository"><a href="#The-repository" class="headerlink" title="The repository"></a>The repository</h2><p>The invoice is accompanied with an InvoiceReposity class implementing IRepository&lt;Invoice&gt; that looks like this</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public interface IRepository&lt;T&gt;</div><div class="line">&#123;</div><div class="line">    T Get(string id);</div><div class="line">    void Update(T instance);</div><div class="line">    T Create(T instance);</div><div class="line">    bool Exists(string id);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>for now we have a list of 1000 prepopulated invoices with id 1-1000. The repository is a simple dictionary.</p>
<h2 id="Looking-for-the-API"><a href="#Looking-for-the-API" class="headerlink" title="Looking for the API"></a>Looking for the API</h2><p>We will center the API around what the business does - that is its domain and the mentioned user stories. With Level 1 in the REST maturity level with introduce resource representations. We use urls to differentiate between these resource representations. So in our case it will be an invoice resource representation. Remember the resource representation does not have to match our domain model. It will be designed from what information we wish to conway, and we may have multiple resource representations for the same domain invoice.</p>
<p>So since we are going for a CRU(D) implementation here our invoice API can look like this</p>
<table>
<thead>
<tr>
<th>Http Verb</th>
<th>Uri</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>invoices/{id}</td>
<td>Get invoice representation</td>
</tr>
<tr>
<td>POST</td>
<td>invoices</td>
<td>Create a new invoice</td>
</tr>
<tr>
<td>PUT</td>
<td>invoices/{id}</td>
<td>Update an existing invoice</td>
</tr>
</tbody>
</table>
<p>Actually we are already getting a good start on Level 2 Http in the maturity model. We are using the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616.html" target="_blank" rel="external">Http protocol</a> verbs, and we must make sure to use status codes correctly, content types and all the other good stuff (safe verbs and idempotency). Now you could ask where the GET invoice/ is. For now it is not there - remember we had 1000 invoices prepopulated - it will need a little more design.</p>
<h3 id="Deciding-on-a-media-type"><a href="#Deciding-on-a-media-type" class="headerlink" title="Deciding on a media type"></a>Deciding on a media type</h3><p>We need to chose a <a href="https://en.wikipedia.org/wiki/Media_type" target="_blank" rel="external">media type</a> for the http calls. Since json is “in” at the moment we could choose application/json. However we would like to have something less general purpose to be able to tell the client about the expected processing model (like introduce hypermedia later). So we create a media type in the vendor tree</p>
<p>application/vnd.restexample.finance+json</p>
<p>assuming we as the owner are called “restexample”. We also added the application name “finance”, but should probably not break it further down, since it will put demands on the client if we have multiple media types. The suffix +json now tells what the underlying representation is.</p>
<p>So in order for us to return any information the client must specify the http header</p>
<p>Accept: application/vnd.restexample.finance+json</p>
<p>or any variant such as */*, application/*.</p>
<p>To enforce the media type we add the following to the Startup class. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    services.AddMvc(LimitFormattersToThisApplication);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LimitFormattersToThisApplication</span>(<span class="params">MvcOptions options</span>)</span></div><div class="line">&#123;</div><div class="line">    options.RespectBrowserAcceptHeader = <span class="literal">true</span>;</div><div class="line">    options.ReturnHttpNotAcceptable = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> customMediaType = <span class="keyword">new</span> MediaTypeHeaderValue(ApiDefinition.ApiMediaType);</div><div class="line"></div><div class="line">    options.SetInputMediaType(customMediaType);</div><div class="line">    options.SetOutputMediaType(customMediaType);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MvcOptionsExtensions</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetInputMediaType</span>(<span class="params"><span class="keyword">this</span> MvcOptions options, MediaTypeHeaderValue mediaType</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> supportedInputMediaTypes = options</div><div class="line">            .InputFormatters</div><div class="line">            .OfType&lt;JsonInputFormatter&gt;()</div><div class="line">            .First()</div><div class="line">            .SupportedMediaTypes;</div><div class="line"></div><div class="line">        SetAllowedMediaType(mediaType, supportedInputMediaTypes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetOutputMediaType</span>(<span class="params"><span class="keyword">this</span> MvcOptions options, MediaTypeHeaderValue mediaType</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> supportedOutputMediaTypes = options</div><div class="line">            .OutputFormatters</div><div class="line">            .OfType&lt;JsonOutputFormatter&gt;()</div><div class="line">            .First()</div><div class="line">            .SupportedMediaTypes;</div><div class="line"></div><div class="line">        SetAllowedMediaType(mediaType, supportedOutputMediaTypes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetAllowedMediaType</span>(<span class="params">MediaTypeHeaderValue mediaType,</span></span></div><div class="line">        MediaTypeCollection supportedInputMediaTypes)</div><div class="line">    &#123;</div><div class="line">        supportedInputMediaTypes.Clear();</div><div class="line">        supportedInputMediaTypes.Add(mediaType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The extension methods sets the output and input media type. Note ReturnHttpNotAcceptable is set to true in order to return </p>
<p>406 Not Acceptable</p>
<p>when the reponse format requested in the accept header does not match our custom media type.</p>
<h3 id="Invoice-resource-representation"><a href="#Invoice-resource-representation" class="headerlink" title="Invoice resource representation"></a>Invoice resource representation</h3><h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h4><p>For now we will use this invoice representation for GET that matches the domain representation except for some value object representations in the domain (DDD term)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attr">"id"</span>: <span class="string">"1000"</span>,</div><div class="line">	<span class="attr">"invoiceDate"</span>: <span class="string">"2016-12-05T00:00Z"</span>,</div><div class="line">	<span class="attr">"dueDate"</span>: <span class="string">"2016-12-12T00:00Z"</span>,</div><div class="line">	<span class="attr">"subTotal"</span>: <span class="number">9050</span>,</div><div class="line">	<span class="attr">"customer"</span>: &#123;</div><div class="line">		<span class="attr">"name"</span>: <span class="string">"Microsoft Development Center"</span>,</div><div class="line">		<span class="attr">"addressLines"</span>: [<span class="string">"Kanalvej 8"</span>, <span class="string">"2800 Kongens Lyngby"</span>]</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">"lines"</span>: [</div><div class="line">		&#123; </div><div class="line">			<span class="attr">"lineNumber"</span>: <span class="number">1</span>, </div><div class="line">			<span class="attr">"description"</span>: <span class="string">"consultancy"</span>, </div><div class="line">			<span class="attr">"quantity"</span>: <span class="number">10</span>, </div><div class="line">			<span class="attr">"itemPrice"</span>: <span class="number">905</span>, </div><div class="line">			<span class="attr">"total"</span>: <span class="number">9050</span> </div><div class="line">		&#125;</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That raises the question of what happens to “total” values on POST or PUT. The answer is we need a different representation without these fields. </p>
<h4 id="PUT-POST"><a href="#PUT-POST" class="headerlink" title="PUT/POST"></a>PUT/POST</h4><p>Besides removing the total values in the resource representation we also remove the id, ie. we will not let it be up to the client to set it (could be a valid option).</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attr">"invoiceDate"</span>: <span class="string">"2016-12-05T00:00Z"</span>,</div><div class="line">	<span class="attr">"dueDate"</span>: <span class="string">"2016-12-12T00:00Z"</span>,</div><div class="line">	<span class="attr">"customer"</span>: &#123;</div><div class="line">		<span class="attr">"name"</span>: <span class="string">"Microsoft Development Center"</span>,</div><div class="line">		<span class="attr">"addressLines"</span>: [<span class="string">"Kanalvej 8"</span>, <span class="string">"2800 Kongens Lyngby"</span>]</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">"lines"</span>: [</div><div class="line">		&#123; </div><div class="line">			<span class="attr">"lineNumber"</span>: <span class="number">1</span>, </div><div class="line">			<span class="attr">"description"</span>: <span class="string">"consultancy"</span>, </div><div class="line">			<span class="attr">"quantity"</span>: <span class="number">10</span>, </div><div class="line">			<span class="attr">"itemPrice"</span>: <span class="number">905</span></div><div class="line">		&#125;</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="The-Invoice-controller"><a href="#The-Invoice-controller" class="headerlink" title="The Invoice controller"></a>The Invoice controller</h3><p>For now we are not going all in on DDD with a separate application service layer, but rather survive with that code in the controller.</p>
<h4 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h4><p>So here is the GET implementation</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[Route(<span class="string">"invoice"</span>)]</div><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">InvoicesController</span> : <span class="title">Controller</span></div><div class="line">&#123;</div><div class="line">...</div><div class="line">    [HttpGet(<span class="string">"&#123;id&#125;"</span>, Name = <span class="string">"GetInvoice"</span>)]</div><div class="line">    <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"><span class="keyword">string</span> id</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> invoice = invoiceRepository.Get(id);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (invoice == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> NotFound();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> Ok(mapper.ToModel(invoice));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>We use a literal in the Route attribute to avoid issues with refactoring. If we cannot find the invoice then we return a 404 Not found. Else we return the invoice. It is mapped to this GET model. Notice the HttpGet specifies a Name. This is used in the Post action later.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">GetInvoice</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset InvoiceDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset DueDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> GetInvoiceCustomer Customer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> SubTotal &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> IEnumerable&lt;GetInvoiceLine&gt; Lines &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I am sure GetInvoice will cause some discussion for now. You could do without different representations for the Http verb’s, but then that would impact on the validation etc. That is the reason behind the choice here as you will see in a moment on POST.</p>
<h4 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h4><p>In post we have more to take into account. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[HttpPost]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Post</span>(<span class="params">[FromBody] UpdateInvoice updateInvoice</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (updateInvoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> createdInvoice = invoiceRepository.Create(updateInvoiceMapper.ToDomain(updateInvoice));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> CreatedAtRoute(<span class="string">"GetInvoice"</span>,</div><div class="line">        <span class="keyword">new</span> &#123; id = createdInvoice.Id &#125;,</div><div class="line">        getInvoiceMapper.ToModel(createdInvoice));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>First of all the request could be malformed in such a way that updateInvoice is null. We will return BadRequest then.</p>
<p>Next is to check if the model is valid. This is one of the reasons for having UpdateInvoice, UpdateInvoiceLine, UpdateInvoiceCustomer models where we decorate with data annotations like shown here</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">UpdateInvoice</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset InvoiceDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> DateTimeOffset DueDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> UpdateInvoiceCustomer Customer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> IEnumerable&lt;UpdateInvoiceLine&gt; Lines &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">UpdateInvoiceLine</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> LineNumber &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> Quantity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> ItemPrice &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line">    [Required(ErrorMessage = <span class="string">"Invoice line description must be specified"</span>)]</div><div class="line">    [MaxLength(<span class="number">500</span>, ErrorMessage = <span class="string">"Invoice line description is too long"</span>)]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Description &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If everything goes well we will return the newly created invoice with a 201 and a Location header for the new resource like shown here</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Thu, 08 Dec 2016 12:40:35 GMT</div><div class="line">Transfer-Encoding: chunked</div><div class="line">Content-Type: application/vnd.restexample.finance+json; charset=utf-8</div><div class="line">Location: http://localhost:5000/invoice/1002</div><div class="line"></div><div class="line">&#123;</div><div class="line">	&quot;invoiceDate&quot;:&quot;2016-12-05T00:00:00+00:00&quot;,</div><div class="line">	&quot;dueDate&quot;:&quot;2016-12-12T00:00:00+00:00&quot;,</div><div class="line">	&quot;customer&quot;:&#123;</div><div class="line">		&quot;name&quot;:&quot;Microsoft Development Center&quot;,</div><div class="line">		&quot;addressLines&quot;:[&quot;Kanalvej 8&quot;,&quot;2800 Kongens Lyngby&quot;]</div><div class="line">		&#125;,</div><div class="line">	&quot;subTotal&quot;:0.0,</div><div class="line">	&quot;lines&quot;:[</div><div class="line">		&#123;&quot;lineNumber&quot;:1,&quot;description&quot;:&quot;test&quot;,&quot;quantity&quot;:10.0,&quot;itemPrice&quot;:1.0,&quot;total&quot;:10.0&#125;</div><div class="line">	],</div><div class="line">	&quot;id&quot;:&quot;1002&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Note that when calling POST we have to add the headers</p>
<p>Accept: application/vnd.restexample.finance+json<br>Content-Type: application/vnd.restexample.finance+json</p>
<p>However the code here in the POST is not pretty when it comes to DRY, but that will be a topic for a later blog.</p>
<h4 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h4><p>With Put we wish to update the invoice. We must supply the full payload for updating. We will in a later blog look at the Patch verb.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[HttpPut(<span class="string">"&#123;id&#125;"</span>)]</div><div class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Put</span>(<span class="params"><span class="keyword">string</span> id, [FromBody] UpdateInvoice updateInvoice</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (updateInvoice == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> BadRequest(ModelState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!invoiceRepository.Exists(id))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> NotFound();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    invoiceRepository.Update(updateInvoiceMapper.ToDomain(updateInvoice, id));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NoContent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The two first validations are simular to Post. Then we check if the invoice exists and return NotFound if not. If we can update then we return NoContent (the client has the invoice already).</p>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h2><p>That is it for the most basic api for now. But we can do much more as we will see in later posts (hopefully).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2016/12/08/Building-a-basic-REST-aspnet-core-example/" data-id="ciwop53c4000547aazxa0r911" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2016/12/08/Building-a-basic-REST-aspnet-core-example/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AspNet-Mvc/">AspNet Mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/REST/">REST</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-automation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/04/azure-automation/" class="article-date">
  <time datetime="2015-03-03T23:00:00.000Z" itemprop="datePublished">Mar 4 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/04/azure-automation/">Automate VM deployment with Azure + Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>We recently started to use Elasticsearch for search within our application. Since we wanted an infrastructure where we could provision multiple services to a cluster we decided to build a VM cluster with docker hosts on each VM.</p>
<p>To be able to quickly reproduce the cluster we decided to automate this task. That is to create the Azure parts needed and the deployment of docker containers. You can do this using Powershell, Azure CLI, kubernetes, mesos etc. We grabbed the chance to use the .NET Azure Management API - so we had the full disposal of C# for a range of custom tasks.</p>
<p>The end result was a .Net command line application that takes a json file with a list of actions, and spin up x number of virtual machines with docker installed and the containers needed. For now we spin up Nginx as a reverse proxy and Elasticsearch behind it.</p>
<p>So this is what we automated:</p>
<p>At Azure level: creating/updating</p>
<ul>
<li>a virtual network for the VMs</li>
<li>storage account for VM harddisks</li>
<li>cloud service for the VMs</li>
<li>uploading ssh keys for use with Linux VMs</li>
<li>virtual machines, including<br>– using resource extensions to install the docker host<br>– adding custom disks to the VMs<br>– adding load balancers with a probe</li>
</ul>
<p>and a hole range of custom tasks for setting up the docker hosts and their storage. You could use Puppet/Chef for this - but in order not to bring in another tool we did it with simple bash scripts.</p>
<p>If this is something you want to do then here is an overview of what we did. To get started all you need to do is to include a range of nuget management packages to a project. They are all starting with the name “Microsoft.WindowsAzure.Management” and then a postfix for each area you can manage, ie .Compute, .Network, .WebSites and so on.</p>
<h2 id="Configuring-the-network"><a href="#Configuring-the-network" class="headerlink" title="Configuring the network"></a>Configuring the network</h2><p>Since we want the cluster to be on its own network then we need to setup a local network. We can use the NetworkManagementClient for this task. However since the API is limited to getting/setting xml we must do a little messy XDocument to add a network. But first let us look at an example of the xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">NetworkConfiguration</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"ht</span></span></div><div class="line">tp://www.w3.org/2001/XMLSchema-instance" <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/Ser</span></div><div class="line">viceHosting/2011/07/NetworkConfiguration"&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">VirtualNetworkConfiguration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Dns</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">VirtualNetworkSites</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">VirtualNetworkSite</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">Location</span>=<span class="string">"North Europe"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">AddressSpace</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">AddressPrefix</span>&gt;</span>10.0.0.0/8<span class="tag">&lt;/<span class="name">AddressPrefix</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">AddressSpace</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Subnets</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">Subnet</span> <span class="attr">name</span>=<span class="string">"Subnet"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">AddressPrefix</span>&gt;</span>10.0.0.0/11<span class="tag">&lt;/<span class="name">AddressPrefix</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">Subnet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Subnets</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">VirtualNetworkSite</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">VirtualNetworkSites</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">VirtualNetworkConfiguration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">NetworkConfiguration</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Here we have a network defined by the VirtualNetworkSite node named “test” and to be hosted in the “North Europe” datacenter. We allocate an overall address space 10.0.0.0/8 and a subnet 10.0.0.0/11. That is basically all we need (if you want the full overview of the schema then look <a href="https://msdn.microsoft.com/en-us/library/azure/jj157100.aspx" target="_blank" rel="external">here</a>. So let us look at an example of how this can be done:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params">CertificateCloudCredentials credentials, Action&lt;<span class="keyword">string</span>, LogType&gt; log, UpdateNetworkSettings settings</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// .. excluded a bunch of code guards</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (</div><div class="line">        NetworkManagementClient client = CloudContext.Clients.CreateVirtualNetworkManagementClient(credentials))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">string</span> configurationXml = BaseNetworkConfigurationXml;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            NetworkGetConfigurationResponse networkConfiguration = <span class="keyword">await</span> client.Networks.GetConfigurationAsync();</div><div class="line">            configurationXml = networkConfiguration.Configuration;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != System.Net.HttpStatusCode.NotFound)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        XDocument document = XDocument.Parse(configurationXml);</div><div class="line">        XNamespace ns = <span class="string">@"http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration"</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (document.Root == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"No network configuration element in the xml"</span>);</div><div class="line">        &#125;</div><div class="line">        XElement configuration = document.Root.Element(ns + VirtualNetworkConfigurationElementName);</div><div class="line">        <span class="keyword">if</span> (configuration == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            configuration = <span class="keyword">new</span> XElement(ns + VirtualNetworkConfigurationElementName);</div><div class="line">            document.Root.Add(configuration);</div><div class="line">        &#125;</div><div class="line">        XElement sites = configuration.Element(ns + VirtualNetworkSitesElementName);</div><div class="line">        <span class="keyword">if</span> (sites == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            sites = <span class="keyword">new</span> XElement(ns + VirtualNetworkSitesElementName);</div><div class="line">            configuration.Add(sites);</div><div class="line">        &#125;</div><div class="line">        XElement site =</div><div class="line">            sites.Elements(ns + VirtualNetworkSiteElementName)</div><div class="line">                .FirstOrDefault(s =&gt; s.Attribute(<span class="string">"name"</span>) != <span class="literal">null</span> &amp;&amp; s.Attribute(<span class="string">"name"</span>).Value == settings.Name);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (site == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            site = <span class="keyword">new</span> XElement(ns + VirtualNetworkSiteElementName);</div><div class="line">            sites.Add(site);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">!settings.UpdateExisting</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        site.SetAttributeValue(<span class="string">"name"</span>, settings.Name);</div><div class="line">        site.SetAttributeValue(<span class="string">"Location"</span>, settings.Location);</div><div class="line"></div><div class="line">        List&lt;XElement&gt; subnets = settings.Subnets.Select(subnetDefinition =&gt;</div><div class="line">            <span class="keyword">new</span> XElement(ns + SubnetElementName, <span class="keyword">new</span> XAttribute(<span class="string">"name"</span>, subnetDefinition.Name),</div><div class="line">                <span class="keyword">new</span> XElement(ns + AddressPrefixElementName, <span class="keyword">new</span> XText(subnetDefinition.Addresses)))).ToList();</div><div class="line"></div><div class="line">        site.ReplaceNodes(<span class="keyword">new</span> XElement(ns + AddressSpaceElementName,</div><div class="line">            <span class="keyword">new</span> XElement(ns + AddressPrefixElementName, <span class="keyword">new</span> XText(settings.AddressSpace))),</div><div class="line">            <span class="keyword">new</span> XElement(ns + SubnetsElementName, subnets));</div><div class="line"></div><div class="line">        <span class="keyword">await</span> client.Networks.SetConfigurationAsync(<span class="keyword">new</span> NetworkSetConfigurationParameters(document.ToString()));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The purpose of this method is to either create or update a local network based on the settings parameter passed in. So first we get a NetworkManagementClient, and then we attempt to get the configuration xml. However, if no networks have been defined we will get a Not Found http status in return. In that case we will just use a xml template defined in BaseNetworkConfigurationXml. Then we do some xml-exercise to either update or add nodes/attributes. Finally we call SetConfigurationAsync to store the new configuration (hopefully you will not need to change your network configuration in parallel - since what would break pretty easily).</p>
<h2 id="Creating-a-storage-account"><a href="#Creating-a-storage-account" class="headerlink" title="Creating a storage account"></a>Creating a storage account</h2><p>We need a storage account to place the VMs on - and in our case we need to add additional disks to the VMs.</p>
<p>Here we use the StorageManagementClient to either create or update the account. Here’s an example of how that could be done:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> BlobConnectionString = <span class="string">"DefaultEndpointsProtocol=https;AccountName=&#123;0&#125;;AccountKey=&#123;1&#125;"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"></span></span></div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateStorageAccountSettings settings)</div><div class="line">&#123;</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (StorageManagementClient client = CloudContext.Clients.CreateStorageManagementClient(credentials))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">string</span> name = settings.Name.ToLowerInvariant();</div><div class="line">        StorageAccountGetResponse existingStorageAccount = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            existingStorageAccount = <span class="keyword">await</span> client.StorageAccounts.GetAsync(name);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (existingStorageAccount == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">await</span> Create(settings, name, client);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">await</span> Update(settings, name, client);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (settings.Containers != <span class="literal">null</span> &amp;&amp; settings.Containers.Count &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            StorageAccountGetKeysResponse storageKeys = <span class="keyword">await</span> client.StorageAccounts.GetKeysAsync(name);</div><div class="line">            CloudStorageAccount storageAccount = CloudStorageAccount.Parse(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, BlobConnectionString, name, storageKeys.PrimaryKey));</div><div class="line">            CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">string</span> container <span class="keyword">in</span> settings.Containers)</div><div class="line">            &#123;</div><div class="line">                log(<span class="keyword">string</span>.Format(</div><div class="line">                    CultureInfo.InvariantCulture,</div><div class="line">                    <span class="string">@"Checking/Creating container &#123;0&#125; in storage account &#123;1&#125;"</span>,</div><div class="line">                    container, name), LogType.Information);</div><div class="line">                CloudBlobContainer containerReference = blobClient.GetContainerReference(container);</div><div class="line">                <span class="keyword">await</span> containerReference.CreateIfNotExistsAsync();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Create</span>(<span class="params">UpdateStorageAccountSettings settings, <span class="keyword">string</span> name, StorageManagementClient client</span>)</span></div><div class="line">&#123;</div><div class="line">    StorageAccountCreateParameters createParameters = <span class="keyword">new</span> StorageAccountCreateParameters &#123;</div><div class="line">        AccountType = settings.Type,</div><div class="line">        Name = name,</div><div class="line">        Label = name.ToBase64(),</div><div class="line">        Description =</div><div class="line">            settings.Description,</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.AffinityGroup))</div><div class="line">    &#123;</div><div class="line">        createParameters.AffinityGroup = settings.AffinityGroup;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        createParameters.Location = settings.Location;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">await</span> client.StorageAccounts.CreateAsync(createParameters);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Update method omitted ... pretty similar to the Create part</span></div></pre></td></tr></table></figure>
<p>We start by looking up the storage account. If it does not exist we call the Create method where the real work is done. The remaining part of RunAsync just creates a list of containers specified in the settings we pass in. Only really interesting thing in Create is that you have to specify an account type, ie. “Standard_LRS”. You can see the list of options [here] (<a href="https://msdn.microsoft.com/en-us/library/azure/ee460802.aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/azure/ee460802.aspx</a>).</p>
<h2 id="Create-a-cloud-service-to-host-the-VMs"><a href="#Create-a-cloud-service-to-host-the-VMs" class="headerlink" title="Create a cloud service to host the VMs"></a>Create a cloud service to host the VMs</h2><p>The virtual machines will run inside a cloud service. We use ComputeManagementClient to create it. Basically all we have to supply is a name for the service, and a location (or affinity group).</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"></span></span></div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateCloudServiceSettings settings)</div><div class="line">&#123;</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    &#123;</div><div class="line">        HostedServiceGetResponse existingService = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            existingService = <span class="keyword">await</span> client.HostedServices.GetAsync(settings.Name);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (existingService == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            HostedServiceCreateParameters parameters = <span class="keyword">new</span> HostedServiceCreateParameters &#123;</div><div class="line">                Description = settings.Description,</div><div class="line">                Label = settings.Name.ToBase64(),</div><div class="line">                ServiceName = settings.Name</div><div class="line">            &#125;;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.AffinityGroup))</div><div class="line">            &#123;</div><div class="line">                parameters.AffinityGroup = settings.Name;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                parameters.Location = settings.Location;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">await</span> client.HostedServices.CreateAsync(parameters);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">await</span> client.HostedServices.UpdateAsync(</div><div class="line">                existingService.ServiceName,</div><div class="line">                <span class="keyword">new</span> HostedServiceUpdateParameters &#123; Description = settings.Description &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Uploading-SSH-certificate-for-the-linux-VMs"><a href="#Uploading-SSH-certificate-for-the-linux-VMs" class="headerlink" title="Uploading SSH certificate for the linux VMs"></a>Uploading SSH certificate for the linux VMs</h2><p>We want our SSH to use a certificate and disable password based authentication. So we upload an SSL certificate like this (a pem file):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"></span></span></div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UploadCertificateSettings settings)</div><div class="line">&#123;</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    &#123;</div><div class="line">        ServiceCertificateGetResponse certificate = <span class="literal">null</span>;</div><div class="line">        X509Certificate2 certificateToUpload = <span class="keyword">new</span> X509Certificate2(settings.File);</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            certificate = <span class="keyword">await</span> client.ServiceCertificates.GetAsync(</div><div class="line">                    <span class="keyword">new</span> ServiceCertificateGetParameters(</div><div class="line">                        settings.ServiceName,</div><div class="line">                        <span class="string">"sha1"</span>,</div><div class="line">                        certificateToUpload.Thumbprint));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (certificate == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            log(<span class="string">"Uploading certificate"</span>, LogType.Information);</div><div class="line">            <span class="keyword">byte</span>[] certificateContent = certificateToUpload.Export(X509ContentType.Pfx);</div><div class="line">            <span class="keyword">await</span></div><div class="line">                client.ServiceCertificates.CreateAsync(</div><div class="line">                    settings.ServiceName,</div><div class="line">                    <span class="keyword">new</span> ServiceCertificateCreateParameters</div><div class="line">                        &#123;</div><div class="line">                            CertificateFormat = CertificateFormat.Pfx,</div><div class="line">                            Data = certificateContent</div><div class="line">                        &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            log(<span class="string">"Certificate already uploaded"</span>, LogType.Information);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We first try to lookup (based on the thumbprint) if the certificate is already there. If not we upload it using CreateAsync. It must be exported to Pfx first. So now we have all the parts ready for creating the virtual machines.</p>
<h2 id="Creating-the-VMs"><a href="#Creating-the-VMs" class="headerlink" title="Creating the VMs"></a>Creating the VMs</h2><p>When creating the virtual machines the interesting part is that we want to use the Docker Resource Extension. This is something you get for free when you use the Azure CLI (not in Powershell at the time I wrote this code). There is more coding to this, so let us break up the process.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(<span class="params"></span></span></div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateVirtualMachinesInCloudServiceSettings settings)</div><div class="line">&#123;</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    &#123;</div><div class="line">        DeploymentGetResponse deployment = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Check if the deployment exists</span></div><div class="line">            deployment = <span class="keyword">await</span> client.Deployments.GetByNameAsync(</div><div class="line">                settings.ServiceName, settings.ServiceName);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div></pre></td></tr></table></figure>
<p>VMs are placed in a deployment in the cloud service (you have a staging and a production slot in the deployment). So first step we do is to lookup the deployment the VM is to be added to. Now depending on whether we are creating the first VM, any subsequent one, or updating existing we will have to use different parts of the API. Let us take a look at how to create the first VM. A VM is a Role in the API. So to create a VM we could do this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">CreateFirst</span>(<span class="params">ComputeManagementClient client, UpdateVirtualMachinesInCloudServiceSettings settings, VirtualMachine virtualMachineSettings</span>)</span></div><div class="line">&#123;</div><div class="line">    Role role = CreateRole(virtualMachineSettings);</div><div class="line"></div><div class="line">    VirtualMachineCreateDeploymentParameters createParameters = <span class="keyword">new</span> VirtualMachineCreateDeploymentParameters</div><div class="line">    &#123;</div><div class="line">        DeploymentSlot = DeploymentSlot.Production,</div><div class="line">        Label = settings.ServiceName,</div><div class="line">        Name = settings.ServiceName,</div><div class="line">        Roles = <span class="keyword">new</span> List&lt;Role&gt; &#123; role &#125;,</div><div class="line">        LoadBalancers = CreateLoadBalancers(settings.LoadBalancers)</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.VirtualNetworkName))</div><div class="line">    &#123;</div><div class="line">        createParameters.VirtualNetworkName = settings.VirtualNetworkName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">await</span> client.VirtualMachines.CreateDeploymentAsync(settings.ServiceName, createParameters);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Role <span class="title">CreateRole</span>(<span class="params">VirtualMachine virtualMachine</span>)</span></div><div class="line">&#123;</div><div class="line">    Role role = <span class="keyword">new</span> Role</div><div class="line">    &#123;</div><div class="line">        ProvisionGuestAgent = <span class="literal">true</span>,</div><div class="line">        RoleName = virtualMachine.Name,</div><div class="line">        Label = virtualMachine.Name,</div><div class="line">        ConfigurationSets = <span class="keyword">new</span> List&lt;ConfigurationSet&gt;(),</div><div class="line">        RoleSize = virtualMachine.Size,</div><div class="line">        RoleType = VirtualMachineRoleType.PersistentVMRole.ToString(),</div><div class="line">        OSVirtualHardDisk = GetOsVirtualHardDisk(virtualMachine)</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(virtualMachine.AvailabilitySet))</div><div class="line">    &#123;</div><div class="line">        role.AvailabilitySetName = virtualMachine.AvailabilitySet;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (virtualMachine.ResourceExtensions != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        role.ResourceExtensionReferences = CreateResourceExtensions(virtualMachine.ResourceExtensions);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (virtualMachine.DataDisks != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        role.DataVirtualHardDisks = CreateDataDisks(virtualMachine.DataDisks);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ConfigureMachine(virtualMachine, role.ConfigurationSets);</div><div class="line">    ConfigureNetwork(virtualMachine.NetworkConfiguration, role.ConfigurationSets);</div><div class="line">    <span class="keyword">return</span> role;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here in the CreateRole method the virtualMachine parameter is configuration settings for the VM. The Role class contains the basic information about the VM like the name, machine size. The OSVirtualHardDisk refers to the OS image we want to base the VM on. Since we want the cluster to be resilient to Azure downtime we have the ability to specify an AvailabilitySet.</p>
<p>When specifying the role we provide an image the VM should be created with. Here is the helper function GetOsVirtualHardDisk:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> OSVirtualHardDisk <span class="title">GetOsVirtualHardDisk</span>(<span class="params">VirtualMachine virtualMachine</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OSVirtualHardDisk &#123;</div><div class="line">        MediaLink = <span class="keyword">new</span> Uri(<span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, StorageUrl, virtualMachine.StorageAccount, virtualMachine.StoragePath)),</div><div class="line">        SourceImageName = virtualMachine.ImageName</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here we refer to a standard image (ie b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04-LTS-amd64-server-20140618.1-en-us-30GB).</p>
<p>To deploy the docker host we need to specify a resource extension. This is what is covered in the CreateResourceExtensions method. Perhaps it may also be useful to see the json that is specified for this method</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">"resourceExtensions": [</div><div class="line">    &#123;</div><div class="line">        "name": "DockerExtension",</div><div class="line">        "publisher": "MSOpenTech.Extensions",</div><div class="line">        "referenceName": "DockerExtension",</div><div class="line">        "version": "0.3",</div><div class="line">        "state": "enable",</div><div class="line">        "useConfigurator": true,</div><div class="line">        "resourceExtensionParameterValues": [</div><div class="line">            &#123;</div><div class="line">                "key": "certificateDirectory",</div><div class="line">                "value": "&#123;certificateDirectory&#125;"</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                "key": "dockerPort",</div><div class="line">                "value": "4243"</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">],</div></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IList&lt;ResourceExtensionReference&gt; <span class="title">CreateResourceExtensions</span>(<span class="params"></span></span></div><div class="line">    IEnumerable&lt;ResourceExtensionReferenceSettings&gt; referenceSettings)</div><div class="line">&#123;</div><div class="line">    List&lt;ResourceExtensionReference&gt; references = <span class="keyword">new</span> List&lt;ResourceExtensionReference&gt;();</div><div class="line">    <span class="keyword">foreach</span> (ResourceExtensionReferenceSettings settings <span class="keyword">in</span> referenceSettings)</div><div class="line">    &#123;</div><div class="line">        IList&lt;ResourceExtensionParameterValue&gt; resourceExtensionParameterValues;</div><div class="line">        <span class="keyword">if</span> (!settings.UseConfigurator)</div><div class="line">        &#123;</div><div class="line">            resourceExtensionParameterValues =</div><div class="line">                settings.ResourceExtensionParameterValues.Select(</div><div class="line">                    values =&gt;</div><div class="line">                    <span class="keyword">new</span> ResourceExtensionParameterValue</div><div class="line">                        &#123;</div><div class="line">                            Key = values.Key,</div><div class="line">                            Type = values.Type,</div><div class="line">                            Value = values.Value</div><div class="line">                        &#125;).ToList();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">bool</span> hasConfigurator = ResourceExtensionConfigurators.ContainsKey(settings.Name);</div><div class="line">            <span class="keyword">if</span> (!hasConfigurator)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                    <span class="keyword">string</span>.Format(</div><div class="line">                        CultureInfo.InvariantCulture,</div><div class="line">                        <span class="string">"Unknown resource extension &#123;0&#125; - found no registered configurator. Cannot continue."</span>,</div><div class="line">                        settings.Name));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            resourceExtensionParameterValues =</div><div class="line">                ResourceExtensionConfigurators[settings.Name](settings.ResourceExtensionParameterValues);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ResourceExtensionReference reference = <span class="keyword">new</span> ResourceExtensionReference</div><div class="line">                &#123;</div><div class="line">                    Name = settings.Name,</div><div class="line">                    Publisher = settings.Publisher,</div><div class="line">                    ReferenceName = settings.ReferenceName,</div><div class="line">                    State = settings.State,</div><div class="line">                    Version = settings.Version,</div><div class="line">                    ResourceExtensionParameterValues = resourceExtensionParameterValues</div><div class="line"></div><div class="line">                &#125;;</div><div class="line">        references.Add(reference);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> references;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The net result is that we need to specify an ResourceExtensionReference instance for docker where,</p>
<ul>
<li>the Name is “DockerExtension”</li>
<li>Publisher is “MSOpenTech.Extensions”</li>
<li>ReferenceName is “DockerExtension”</li>
<li>and a version eg. “0.3” and two sets of key-value parameters<br>– one is key = “dockerPort” with eg value = “4243”<br>– and then the certificates to secure docker</li>
</ul>
<p>As you can see from the code above we have a configurator configuration for parameters that requires special handling. So to configure the docker resource extension we use this configurator.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DockerExtensionConfigurator</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> CertificateDirectoryParameterName = <span class="string">"certificateDirectory"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> DockerPortParameterName = <span class="string">"dockerPort"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ParameterNotFound = <span class="string">"Resource extension parameter &#123;0&#125; must be specified"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> FileNotFound = <span class="string">"File &#123;0&#125; not found"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> CaCertFileName = <span class="string">"ca.pem"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ServerCertFileName = <span class="string">"server-cert.pem"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ServerKeyFileName = <span class="string">"server-key.pem"</span>;</div><div class="line"></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> Configure docker extension</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IList&lt;ResourceExtensionParameterValue&gt; <span class="title">Configure</span>(<span class="params"></span></span></div><div class="line">        ICollection&lt;ResourceExtensionParameterValueSettings&gt; parameters)</div><div class="line">    &#123;</div><div class="line">        List&lt;ResourceExtensionParameterValue&gt; convertedParameters = <span class="keyword">new</span> List&lt;ResourceExtensionParameterValue&gt;();</div><div class="line"></div><div class="line">        ResourceExtensionParameterValue certificates = GetCertificates(parameters);</div><div class="line">        ResourceExtensionParameterValue dockerPort = GetDockerPort(parameters);</div><div class="line">        convertedParameters.Add(certificates);</div><div class="line">        convertedParameters.Add(dockerPort);</div><div class="line">        <span class="keyword">return</span> convertedParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ResourceExtensionParameterValue <span class="title">GetDockerPort</span>(<span class="params">IEnumerable&lt;ResourceExtensionParameterValueSettings&gt; parameters</span>)</span></div><div class="line">    &#123;</div><div class="line">        ResourceExtensionParameterValueSettings dockerPort =</div><div class="line">            parameters.FirstOrDefault(parameter =&gt; parameter.Key == DockerPortParameterName);</div><div class="line">        <span class="keyword">if</span> (dockerPort == <span class="literal">null</span> || <span class="keyword">string</span>.IsNullOrWhiteSpace(dockerPort.Value))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, ParameterNotFound, DockerPortParameterName));</div><div class="line">        &#125;</div><div class="line">        JObject <span class="keyword">value</span> = <span class="keyword">new</span> JObject(<span class="keyword">new</span> JProperty(<span class="string">"dockerport"</span>, dockerPort.Value));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResourceExtensionParameterValue &#123;</div><div class="line">            Type = <span class="string">"Public"</span>,</div><div class="line">            Key = <span class="string">"ignored"</span>,</div><div class="line">            Value = <span class="keyword">value</span>.ToString(Formatting.None)</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ResourceExtensionParameterValue <span class="title">GetCertificates</span>(<span class="params">IEnumerable&lt;ResourceExtensionParameterValueSettings&gt; parameters</span>)</span></div><div class="line">    &#123;</div><div class="line">        ResourceExtensionParameterValueSettings certificateDirectory =</div><div class="line">            parameters.FirstOrDefault(parameter =&gt; parameter.Key == CertificateDirectoryParameterName);</div><div class="line">        <span class="keyword">if</span> (certificateDirectory == <span class="literal">null</span> || <span class="keyword">string</span>.IsNullOrWhiteSpace(certificateDirectory.Value))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, ParameterNotFound, CertificateDirectoryParameterName));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">string</span> caFileName = Path.Combine(certificateDirectory.Value, CaCertFileName);</div><div class="line">        <span class="keyword">string</span> serverCertFileName = Path.Combine(certificateDirectory.Value, ServerCertFileName);</div><div class="line">        <span class="keyword">string</span> serverKeyFileName = Path.Combine(certificateDirectory.Value, ServerKeyFileName);</div><div class="line"></div><div class="line">        CheckFileExists(caFileName);</div><div class="line">        CheckFileExists(serverCertFileName);</div><div class="line">        CheckFileExists(serverKeyFileName);</div><div class="line"></div><div class="line">        JObject <span class="keyword">value</span> = <span class="keyword">new</span> JObject(</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"ca"</span>, GetFileAsBase64(caFileName)),</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"server-cert"</span>, GetFileAsBase64(serverCertFileName)),</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"server-key"</span>, GetFileAsBase64(serverKeyFileName)));</div><div class="line"></div><div class="line">        ResourceExtensionParameterValue certificates = <span class="keyword">new</span> ResourceExtensionParameterValue</div><div class="line">            &#123;</div><div class="line">                Key = <span class="string">"ignored"</span>,</div><div class="line">                Value = <span class="keyword">value</span>.ToString(Formatting.None),</div><div class="line">                Type = <span class="string">"Private"</span></div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">return</span> certificates;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetFileAsBase64</span>(<span class="params"><span class="keyword">string</span> fileName</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Convert.ToBase64String(File.ReadAllBytes(fileName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckFileExists</span>(<span class="params"><span class="keyword">string</span> fileName</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!File.Exists(fileName))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, FileNotFound, fileName),</div><div class="line">                fileName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Basically the certificate part is just a question of providing a json value with base64 encodings for the certificates.</p>
<p>Back to CreateRole besides creating data disks which is just providing a list of DataVirtualHardDisk instances. Then the roles ConfigurationSets must be specified. This is done in</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ConfigureMachine(virtualMachine, role.ConfigurationSets);</div><div class="line">ConfigureNetwork(virtualMachine.NetworkConfiguration, role.ConfigurationSets);</div><div class="line">...</div></pre></td></tr></table></figure>
<p>This first one configures the user name, password, hostname, timezone etc.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureMachine</span>(<span class="params">VirtualMachine virtualMachine, IList&lt;ConfigurationSet&gt; configurationSets</span>)</span></div><div class="line">&#123;</div><div class="line">    ConfigurationSet machineConfiguration = <span class="keyword">new</span> ConfigurationSet</div><div class="line">                                                &#123;</div><div class="line">                                                    ResetPasswordOnFirstLogon = <span class="literal">false</span>,</div><div class="line">                                                    EnableAutomaticUpdates = <span class="literal">false</span>,</div><div class="line">                                                    ComputerName = virtualMachine.Name,</div><div class="line">                                                    AdminUserName = virtualMachine.AdminUserName,</div><div class="line">                                                    AdminPassword = virtualMachine.AdminPassword,</div><div class="line">                                                    HostName = virtualMachine.Name,</div><div class="line">                                                    SubnetNames = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(),</div><div class="line">                                                &#125;;</div><div class="line">    configurationSets.Add(machineConfiguration);</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(virtualMachine.Timezone))</div><div class="line">    &#123;</div><div class="line">        machineConfiguration.TimeZone = virtualMachine.Timezone;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (virtualMachine.Type.ToLowerInvariant() == WindowsProvisioningConfiguration)</div><div class="line">    &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        machineConfiguration.ConfigurationSetType = ConfigurationSetTypes.LinuxProvisioningConfiguration;</div><div class="line">        machineConfiguration.DisableSshPasswordAuthentication = <span class="literal">false</span>;</div><div class="line">        machineConfiguration.UserName = virtualMachine.AdminUserName;</div><div class="line">        machineConfiguration.UserPassword = virtualMachine.AdminPassword;</div><div class="line">        <span class="keyword">if</span> (virtualMachine.Ssh != <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(virtualMachine.Ssh.CertificateFile)</div><div class="line">                || !File.Exists(virtualMachine.Ssh.CertificateFile))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"SSH certificate file does not exist or is not specified"</span>);</div><div class="line">            &#125;</div><div class="line">            machineConfiguration.SshSettings =</div><div class="line">                <span class="keyword">new</span> Microsoft.WindowsAzure.Management.Compute.Models.SshSettings();</div><div class="line">            machineConfiguration.DisableSshPasswordAuthentication = <span class="literal">true</span>;</div><div class="line"></div><div class="line">            X509Certificate2 certificate = <span class="keyword">new</span> X509Certificate2();</div><div class="line">            certificate.Import(virtualMachine.Ssh.CertificateFile);</div><div class="line">            machineConfiguration.SshSettings.PublicKeys.Add(</div><div class="line">                <span class="keyword">new</span> SshSettingPublicKey(</div><div class="line">                    certificate.Thumbprint,</div><div class="line">                    <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, <span class="string">"//home/&#123;0&#125;//.ssh//authorized_keys"</span>, virtualMachine.AdminUserName)));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If we have specified ssh in the configuration then we refer to the previously uploaded certificate. Then for the network,</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureNetwork</span>(<span class="params">VirtualMachineNetworkConfiguration network, IList&lt;ConfigurationSet&gt; configurationSets</span>)</span></div><div class="line">&#123;</div><div class="line">    ConfigurationSet networkConfiguration = <span class="keyword">new</span> ConfigurationSet &#123;</div><div class="line">        ConfigurationSetType = ConfigurationSetTypes.NetworkConfiguration,</div><div class="line">        SubnetNames = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;()</div><div class="line">    &#125;;</div><div class="line">    configurationSets.Add(networkConfiguration);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(network.Ip))</div><div class="line">    &#123;</div><div class="line">        networkConfiguration.StaticVirtualNetworkIPAddress = network.Ip;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (network.SubnetNames != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        List&lt;<span class="keyword">string</span>&gt; names = network.SubnetNames.ToList();</div><div class="line">        networkConfiguration.SubnetNames = names;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (network.Endpoints != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (EndpointSetting endpoint <span class="keyword">in</span> network.Endpoints)</div><div class="line">        &#123;</div><div class="line">            InputEndpoint inputEndpoint = <span class="keyword">new</span> InputEndpoint &#123;</div><div class="line">                Port = endpoint.Port,</div><div class="line">                LocalPort = endpoint.LocalPort,</div><div class="line">                EnableDirectServerReturn = endpoint.EnableDirectServerReturn,</div><div class="line">                Protocol = endpoint.Protocol</div><div class="line">            &#125;;</div><div class="line">            <span class="keyword">if</span> (endpoint.AclRules != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                inputEndpoint.EndpointAcl = <span class="keyword">new</span> EndpointAcl &#123;</div><div class="line">                    Rules = endpoint.AclRules.Select(rule =&gt;</div><div class="line">                        <span class="keyword">new</span> AccessControlListRule &#123;</div><div class="line">                            Action = rule.Action,</div><div class="line">                            Description = rule.Description,</div><div class="line">                            Order = rule.Order,</div><div class="line">                            RemoteSubnet = rule.RemoteSubnet&#125;).ToList()</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.Name))</div><div class="line">            &#123;</div><div class="line">                inputEndpoint.Name = endpoint.Name;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.LoadBalancedEndpointSetName))</div><div class="line">            &#123;</div><div class="line">                inputEndpoint.LoadBalancedEndpointSetName = endpoint.LoadBalancedEndpointSetName;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.LoadBalancerName))</div><div class="line">            &#123;</div><div class="line">                inputEndpoint.LoadBalancerName = endpoint.LoadBalancerName;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (endpoint.LoadBalancerProbe != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                inputEndpoint.LoadBalancerProbe =</div><div class="line">                    <span class="keyword">new</span> Microsoft.WindowsAzure.Management.Compute.Models.LoadBalancerProbe &#123;</div><div class="line">                        IntervalInSeconds = endpoint.LoadBalancerProbe.IntervalInSeconds,</div><div class="line">                        Path = endpoint.LoadBalancerProbe.Path,</div><div class="line">                        Port = endpoint.LoadBalancerProbe.Port,</div><div class="line">                        Protocol = endpoint.LoadBalancerProbe.Protocol == <span class="string">"http"</span> ? LoadBalancerProbeTransportProtocol.Http : LoadBalancerProbeTransportProtocol.Tcp,</div><div class="line">                        TimeoutInSeconds = endpoint.LoadBalancerProbe.TimeoutInSeconds</div><div class="line">                    &#125;;</div><div class="line">            &#125;</div><div class="line">            networkConfiguration.InputEndpoints.Add(inputEndpoint);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here we setup the subnet, ip, endpoints - with endpoint security and possibly load balancer with a probe.</p>
<h2 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h2><p>That is basically what we did for the Azure part. The docker container deployment is another story.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2015/03/04/azure-automation/" data-id="ciwop53c5000647aa66t4fv0g" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2015/03/04/azure-automation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-idea-behind-this-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/17/idea-behind-this-blog/" class="article-date">
  <time datetime="2015-02-16T23:00:00.000Z" itemprop="datePublished">Feb 17 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/17/idea-behind-this-blog/">Idea behind this blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>This blog is for documenting my learning path and experiments with code. It is for doing all those things that cannot fit into the work day. It is also my way of reaching out for getting your take on things - should I be so lucky to get comments on a post.</p>
<p>Currently I am working fulltime as a consultant with cloud web solutions as a fullstack developer. Hopefully this might lead to blogs about Windows Azure, Docker, .Net, Javascript, Css/Svg/Less/Html, Patterns, Testing, Different kind of databases and other stuff. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2015/02/17/idea-behind-this-blog/" data-id="ciwop53c2000447aaogssuaql" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2015/02/17/idea-behind-this-blog/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET-Core/">.NET Core</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AspNet-Mvc/">AspNet Mvc</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/REST/">REST</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 20px;">.NET Core</a> <a href="/tags/AspNet-Mvc/" style="font-size: 20px;">AspNet Mvc</a> <a href="/tags/Azure/" style="font-size: 10px;">Azure</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/REST/" style="font-size: 20px;">REST</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/14/Building-a-basic-REST-AspNet-Core-Example-Part-4/">Building a basic REST AspNet Core Example - Part 4</a>
          </li>
        
          <li>
            <a href="/2016/12/12/Building-a-basic-REST-aspnet-core-example-Part-3/">Building a basic REST AspNet Core Example - Part 3 </a>
          </li>
        
          <li>
            <a href="/2016/12/09/Building-a-basic-REST-aspnet-core-example-Part-2/">Building a basic REST AspNet Core Example - Part 2</a>
          </li>
        
          <li>
            <a href="/2016/12/08/Building-a-basic-REST-aspnet-core-example/">Building a basic REST AspNet Core Example - Part 1</a>
          </li>
        
          <li>
            <a href="/2015/03/04/azure-automation/">Automate VM deployment with Azure + Docker</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Mikael Kühn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'codeplayground';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>