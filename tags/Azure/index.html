<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: Azure | Code Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Code Playground">
<meta property="og:url" content="http://blog.codeplayground.org/tags/Azure/">
<meta property="og:site_name" content="Code Playground">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code Playground">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="Code Playground" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-3286820-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Code Playground</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Learning something daily</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-azure-automation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/04/azure-automation/" class="article-date">
  <time datetime="2015-03-04T20:43:39.000Z" itemprop="datePublished">Mar 4 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/04/azure-automation/">Automate VM deployment with Azure + Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>We recently started to use Elasticsearch for search within our application. Since we wanted an infrastructure where we could provision multiple services to a cluster we decided to build a VM cluster with docker hosts on each VM.</p>
<p>To be able to quickly reproduce the cluster we decided to automate this task. That is to create the Azure parts needed and the deployment of docker containers. You can do this using Powershell, Azure CLI, kubernetes, mesos etc. We grabbed the chance to use the .NET Azure Management API - so we had the full disposal of C# for a range of custom tasks.</p>
<p>The end result was a .Net command line application that takes a json file with a list of actions, and spin up x number of virtual machines with docker installed and the containers needed. For now we spin up Nginx as a reverse proxy and Elasticsearch behind it.</p>
<p>So this is what we automated:</p>
<p>At Azure level: creating/updating</p>
<ul>
<li>a virtual network for the VMs</li>
<li>storage account for VM harddisks</li>
<li>cloud service for the VMs</li>
<li>uploading ssh keys for use with Linux VMs</li>
<li>virtual machines, including<br>— using resource extensions to install the docker host<br>— adding custom disks to the VMs<br>— adding load balancers with a probe</li>
</ul>
<p>and a hole range of custom tasks for setting up the docker hosts and their storage. You could use Puppet/Chef for this - but in order not to bring in another tool we did it with simple bash scripts.</p>
<p>If this is something you want to do then here is an overview of what we did. To get started all you need to do is to include a range of nuget management packages to a project. They are all starting with the name “Microsoft.WindowsAzure.Management” and then a postfix for each area you can manage, ie .Compute, .Network, .WebSites and so on.</p>
<h2 id="Configuring_the_network">Configuring the network</h2>
<p>Since we want the cluster to be on its own network then we need to setup a local network. We can use the NetworkManagementClient for this task. However since the API is limited to getting/setting xml we must do a little messy XDocument to add a network. But first let us look at an example of the xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">NetworkConfiguration</span> <span class="attribute">xmlns:xsd</span>=<span class="value">"http://www.w3.org/2001/XMLSchema"</span> <span class="attribute">xmlns:xsi</span>=<span class="value">"ht</span></span></div><div class="line">tp://www.w3.org/2001/XMLSchema-instance" <span class="attribute">xmlns</span>=<span class="value">"http://schemas.microsoft.com/Ser</span></div><div class="line">viceHosting/2011/07/NetworkConfiguration"&gt;</div><div class="line">  <span class="tag">&lt;<span class="title">VirtualNetworkConfiguration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">Dns</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">VirtualNetworkSites</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="title">VirtualNetworkSite</span> <span class="attribute">name</span>=<span class="value">"test"</span> <span class="attribute">Location</span>=<span class="value">"North Europe"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">AddressSpace</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">AddressPrefix</span>&gt;</span>10.0.0.0/8<span class="tag">&lt;/<span class="title">AddressPrefix</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">AddressSpace</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">Subnets</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="title">Subnet</span> <span class="attribute">name</span>=<span class="value">"Subnet"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">AddressPrefix</span>&gt;</span>10.0.0.0/11<span class="tag">&lt;/<span class="title">AddressPrefix</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="title">Subnet</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">Subnets</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="title">VirtualNetworkSite</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">VirtualNetworkSites</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="title">VirtualNetworkConfiguration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">NetworkConfiguration</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Here we have a network defined by the VirtualNetworkSite node named “test” and to be hosted in the “North Europe” datacenter. We allocate an overall address space 10.0.0.0/8 and a subnet 10.0.0.0/11. That is basically all we need (if you want the full overview of the schema then look <a href="https://msdn.microsoft.com/en-us/library/azure/jj157100.aspx" target="_blank" rel="external">here</a>. So let us look at an example of how this can be done:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(CertificateCloudCredentials credentials, Action&lt;<span class="keyword">string</span>, LogType&gt; log, UpdateNetworkSettings settings)</div><div class="line">{</div><div class="line">    <span class="comment">// .. excluded a bunch of code guards</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (</div><div class="line">        NetworkManagementClient client = CloudContext.Clients.CreateVirtualNetworkManagementClient(credentials))</div><div class="line">    {</div><div class="line">        <span class="keyword">string</span> configurationXml = BaseNetworkConfigurationXml;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        {</div><div class="line">            NetworkGetConfigurationResponse networkConfiguration = <span class="keyword">await</span> client.Networks.GetConfigurationAsync();</div><div class="line">            configurationXml = networkConfiguration.Configuration;</div><div class="line">        }</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != System.Net.HttpStatusCode.NotFound)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        XDocument document = XDocument.Parse(configurationXml);</div><div class="line">        XNamespace ns = <span class="string">@"http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration"</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (document.Root == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"No network configuration element in the xml"</span>);</div><div class="line">        }</div><div class="line">        XElement configuration = document.Root.Element(ns + VirtualNetworkConfigurationElementName);</div><div class="line">        <span class="keyword">if</span> (configuration == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            configuration = <span class="keyword">new</span> XElement(ns + VirtualNetworkConfigurationElementName);</div><div class="line">            document.Root.Add(configuration);</div><div class="line">        }</div><div class="line">        XElement sites = configuration.Element(ns + VirtualNetworkSitesElementName);</div><div class="line">        <span class="keyword">if</span> (sites == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            sites = <span class="keyword">new</span> XElement(ns + VirtualNetworkSitesElementName);</div><div class="line">            configuration.Add(sites);</div><div class="line">        }</div><div class="line">        XElement site =</div><div class="line">            sites.Elements(ns + VirtualNetworkSiteElementName)</div><div class="line">                .FirstOrDefault(s =&gt; s.Attribute(<span class="string">"name"</span>) != <span class="keyword">null</span> && s.Attribute(<span class="string">"name"</span>).Value == settings.Name);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (site == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            site = <span class="keyword">new</span> XElement(ns + VirtualNetworkSiteElementName);</div><div class="line">            sites.Add(site);</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!settings.UpdateExisting)</div><div class="line">        {</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        site.SetAttributeValue(<span class="string">"name"</span>, settings.Name);</div><div class="line">        site.SetAttributeValue(<span class="string">"Location"</span>, settings.Location);</div><div class="line"></div><div class="line">        List&lt;XElement&gt; subnets = settings.Subnets.Select(subnetDefinition =&gt;</div><div class="line">            <span class="keyword">new</span> XElement(ns + SubnetElementName, <span class="keyword">new</span> XAttribute(<span class="string">"name"</span>, subnetDefinition.Name),</div><div class="line">                <span class="keyword">new</span> XElement(ns + AddressPrefixElementName, <span class="keyword">new</span> XText(subnetDefinition.Addresses)))).ToList();</div><div class="line"></div><div class="line">        site.ReplaceNodes(<span class="keyword">new</span> XElement(ns + AddressSpaceElementName,</div><div class="line">            <span class="keyword">new</span> XElement(ns + AddressPrefixElementName, <span class="keyword">new</span> XText(settings.AddressSpace))),</div><div class="line">            <span class="keyword">new</span> XElement(ns + SubnetsElementName, subnets));</div><div class="line"></div><div class="line">        <span class="keyword">await</span> client.Networks.SetConfigurationAsync(<span class="keyword">new</span> NetworkSetConfigurationParameters(document.ToString()));</div><div class="line">    }</div><div class="line">}</div><div class="line">}</div></pre></td></tr></table></figure>

<p>The purpose of this method is to either create or update a local network based on the settings parameter passed in. So first we get a NetworkManagementClient, and then we attempt to get the configuration xml. However, if no networks have been defined we will get a Not Found http status in return. In that case we will just use a xml template defined in BaseNetworkConfigurationXml. Then we do some xml-exercise to either update or add nodes/attributes. Finally we call SetConfigurationAsync to store the new configuration (hopefully you will not need to change your network configuration in parallel - since what would break pretty easily).</p>
<h2 id="Creating_a_storage_account">Creating a storage account</h2>
<p>We need a storage account to place the VMs on - and in our case we need to add additional disks to the VMs.</p>
<p>Here we use the StorageManagementClient to either create or update the account. Here’s an example of how that could be done:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> BlobConnectionString = <span class="string">"DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}"</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(</div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateStorageAccountSettings settings)</div><div class="line">{</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (StorageManagementClient client = CloudContext.Clients.CreateStorageManagementClient(credentials))</div><div class="line">    {</div><div class="line">        <span class="keyword">string</span> name = settings.Name.ToLowerInvariant();</div><div class="line">        StorageAccountGetResponse existingStorageAccount = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        {</div><div class="line">            existingStorageAccount = <span class="keyword">await</span> client.StorageAccounts.GetAsync(name);</div><div class="line">        }</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (existingStorageAccount == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            <span class="keyword">await</span> Create(settings, name, client);</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span></div><div class="line">        {</div><div class="line">            <span class="keyword">await</span> Update(settings, name, client);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (settings.Containers != <span class="keyword">null</span> && settings.Containers.Count &gt; <span class="number">0</span>)</div><div class="line">        {</div><div class="line">            StorageAccountGetKeysResponse storageKeys = <span class="keyword">await</span> client.StorageAccounts.GetKeysAsync(name);</div><div class="line">            CloudStorageAccount storageAccount = CloudStorageAccount.Parse(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, BlobConnectionString, name, storageKeys.PrimaryKey));</div><div class="line">            CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">string</span> container <span class="keyword">in</span> settings.Containers)</div><div class="line">            {</div><div class="line">                log(<span class="keyword">string</span>.Format(</div><div class="line">                    CultureInfo.InvariantCulture,</div><div class="line">                    <span class="string">@"Checking/Creating container {0} in storage account {1}"</span>,</div><div class="line">                    container, name), LogType.Information);</div><div class="line">                CloudBlobContainer containerReference = blobClient.GetContainerReference(container);</div><div class="line">                <span class="keyword">await</span> containerReference.CreateIfNotExistsAsync();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Create</span>(UpdateStorageAccountSettings settings, <span class="keyword">string</span> name, StorageManagementClient client)</div><div class="line">{</div><div class="line">    StorageAccountCreateParameters createParameters = <span class="keyword">new</span> StorageAccountCreateParameters {</div><div class="line">        AccountType = settings.Type,</div><div class="line">        Name = name,</div><div class="line">        Label = name.ToBase64(),</div><div class="line">        Description =</div><div class="line">            settings.Description,</div><div class="line">    };</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.AffinityGroup))</div><div class="line">    {</div><div class="line">        createParameters.AffinityGroup = settings.AffinityGroup;</div><div class="line">    }</div><div class="line">    <span class="keyword">else</span></div><div class="line">    {</div><div class="line">        createParameters.Location = settings.Location;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">await</span> client.StorageAccounts.CreateAsync(createParameters);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Update method omitted ... pretty similar to the Create part</span></div></pre></td></tr></table></figure>

<p>We start by looking up the storage account. If it does not exist we call the Create method where the real work is done. The remaining part of RunAsync just creates a list of containers specified in the settings we pass in. Only really interesting thing in Create is that you have to specify an account type, ie. “Standard_LRS”. You can see the list of options [here] (<a href="https://msdn.microsoft.com/en-us/library/azure/ee460802.aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/azure/ee460802.aspx</a>).</p>
<h2 id="Create_a_cloud_service_to_host_the_VMs">Create a cloud service to host the VMs</h2>
<p>The virtual machines will run inside a cloud service. We use ComputeManagementClient to create it. Basically all we have to supply is a name for the service, and a location (or affinity group).</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(</div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateCloudServiceSettings settings)</div><div class="line">{</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    {</div><div class="line">        HostedServiceGetResponse existingService = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        {</div><div class="line">            existingService = <span class="keyword">await</span> client.HostedServices.GetAsync(settings.Name);</div><div class="line">        }</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (existingService == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            HostedServiceCreateParameters parameters = <span class="keyword">new</span> HostedServiceCreateParameters {</div><div class="line">                Description = settings.Description,</div><div class="line">                Label = settings.Name.ToBase64(),</div><div class="line">                ServiceName = settings.Name</div><div class="line">            };</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.AffinityGroup))</div><div class="line">            {</div><div class="line">                parameters.AffinityGroup = settings.Name;</div><div class="line">            }</div><div class="line">            <span class="keyword">else</span></div><div class="line">            {</div><div class="line">                parameters.Location = settings.Location;</div><div class="line">            }</div><div class="line">            <span class="keyword">await</span> client.HostedServices.CreateAsync(parameters);</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span></div><div class="line">        {</div><div class="line">            <span class="keyword">await</span> client.HostedServices.UpdateAsync(</div><div class="line">                existingService.ServiceName,</div><div class="line">                <span class="keyword">new</span> HostedServiceUpdateParameters { Description = settings.Description });</div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Uploading_SSH_certificate_for_the_linux_VMs">Uploading SSH certificate for the linux VMs</h2>
<p>We want our SSH to use a certificate and disable password based authentication. So we upload an SSL certificate like this (a pem file):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(</div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UploadCertificateSettings settings)</div><div class="line">{</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    {</div><div class="line">        ServiceCertificateGetResponse certificate = <span class="keyword">null</span>;</div><div class="line">        X509Certificate2 certificateToUpload = <span class="keyword">new</span> X509Certificate2(settings.File);</div><div class="line">        <span class="keyword">try</span></div><div class="line">        {</div><div class="line">            certificate = <span class="keyword">await</span> client.ServiceCertificates.GetAsync(</div><div class="line">                    <span class="keyword">new</span> ServiceCertificateGetParameters(</div><div class="line">                        settings.ServiceName,</div><div class="line">                        <span class="string">"sha1"</span>,</div><div class="line">                        certificateToUpload.Thumbprint));</div><div class="line">        }</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (certificate == <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            log(<span class="string">"Uploading certificate"</span>, LogType.Information);</div><div class="line">            <span class="keyword">byte</span>[] certificateContent = certificateToUpload.Export(X509ContentType.Pfx);</div><div class="line">            <span class="keyword">await</span></div><div class="line">                client.ServiceCertificates.CreateAsync(</div><div class="line">                    settings.ServiceName,</div><div class="line">                    <span class="keyword">new</span> ServiceCertificateCreateParameters</div><div class="line">                        {</div><div class="line">                            CertificateFormat = CertificateFormat.Pfx,</div><div class="line">                            Data = certificateContent</div><div class="line">                        });</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span></div><div class="line">        {</div><div class="line">            log(<span class="string">"Certificate already uploaded"</span>, LogType.Information);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>

<p>We first try to lookup (based on the thumbprint) if the certificate is already there. If not we upload it using CreateAsync. It must be exported to Pfx first. So now we have all the parts ready for creating the virtual machines.</p>
<h2 id="Creating_the_VMs">Creating the VMs</h2>
<p>When creating the virtual machines the interesting part is that we want to use the Docker Resource Extension. This is something you get for free when you use the Azure CLI (not in Powershell at the time I wrote this code). There is more coding to this, so let us break up the process.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunAsync</span>(</div><div class="line">    CertificateCloudCredentials credentials,</div><div class="line">    Action&lt;<span class="keyword">string</span>, LogType&gt; log,</div><div class="line">    UpdateVirtualMachinesInCloudServiceSettings settings)</div><div class="line">{</div><div class="line">    <span class="comment">/* .. excluded a range of code guards **/</span></div><div class="line"></div><div class="line">    <span class="keyword">using</span> (ComputeManagementClient client = CloudContext.Clients.CreateComputeManagementClient(credentials))</div><div class="line">    {</div><div class="line">        DeploymentGetResponse deployment = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        {</div><div class="line">            <span class="comment">// Check if the deployment exists</span></div><div class="line">            deployment = <span class="keyword">await</span> client.Deployments.GetByNameAsync(</div><div class="line">                settings.ServiceName, settings.ServiceName);</div><div class="line">        }</div><div class="line">        <span class="keyword">catch</span> (CloudException e)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (e.Response.StatusCode != HttpStatusCode.NotFound)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        ...</div></pre></td></tr></table></figure>

<p>VMs are placed in a deployment in the cloud service (you have a staging and a production slot in the deployment). So first step we do is to lookup the deployment the VM is to be added to. Now depending on whether we are creating the first VM, any subsequent one, or updating existing we will have to use different parts of the API. Let us take a look at how to create the first VM. A VM is a Role in the API. So to create a VM we could do this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">CreateFirst</span>(ComputeManagementClient client, UpdateVirtualMachinesInCloudServiceSettings settings, VirtualMachine virtualMachineSettings)</div><div class="line">{</div><div class="line">    Role role = CreateRole(virtualMachineSettings);</div><div class="line"></div><div class="line">    VirtualMachineCreateDeploymentParameters createParameters = <span class="keyword">new</span> VirtualMachineCreateDeploymentParameters</div><div class="line">    {</div><div class="line">        DeploymentSlot = DeploymentSlot.Production,</div><div class="line">        Label = settings.ServiceName,</div><div class="line">        Name = settings.ServiceName,</div><div class="line">        Roles = <span class="keyword">new</span> List&lt;Role&gt; { role },</div><div class="line">        LoadBalancers = CreateLoadBalancers(settings.LoadBalancers)</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(settings.VirtualNetworkName))</div><div class="line">    {</div><div class="line">        createParameters.VirtualNetworkName = settings.VirtualNetworkName;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">await</span> client.VirtualMachines.CreateDeploymentAsync(settings.ServiceName, createParameters);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Role <span class="title">CreateRole</span>(VirtualMachine virtualMachine)</div><div class="line">{</div><div class="line">    Role role = <span class="keyword">new</span> Role</div><div class="line">    {</div><div class="line">        ProvisionGuestAgent = <span class="keyword">true</span>,</div><div class="line">        RoleName = virtualMachine.Name,</div><div class="line">        Label = virtualMachine.Name,</div><div class="line">        ConfigurationSets = <span class="keyword">new</span> List&lt;ConfigurationSet&gt;(),</div><div class="line">        RoleSize = virtualMachine.Size,</div><div class="line">        RoleType = VirtualMachineRoleType.PersistentVMRole.ToString(),</div><div class="line">        OSVirtualHardDisk = GetOsVirtualHardDisk(virtualMachine)</div><div class="line">    };</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(virtualMachine.AvailabilitySet))</div><div class="line">    {</div><div class="line">        role.AvailabilitySetName = virtualMachine.AvailabilitySet;</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (virtualMachine.ResourceExtensions != <span class="keyword">null</span>)</div><div class="line">    {</div><div class="line">        role.ResourceExtensionReferences = CreateResourceExtensions(virtualMachine.ResourceExtensions);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (virtualMachine.DataDisks != <span class="keyword">null</span>)</div><div class="line">    {</div><div class="line">        role.DataVirtualHardDisks = CreateDataDisks(virtualMachine.DataDisks);</div><div class="line">    }</div><div class="line"></div><div class="line">    ConfigureMachine(virtualMachine, role.ConfigurationSets);</div><div class="line">    ConfigureNetwork(virtualMachine.NetworkConfiguration, role.ConfigurationSets);</div><div class="line">    <span class="keyword">return</span> role;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Here in the CreateRole method the virtualMachine parameter is configuration settings for the VM. The Role class contains the basic information about the VM like the name, machine size. The OSVirtualHardDisk refers to the OS image we want to base the VM on. Since we want the cluster to be resilient to Azure downtime we have the ability to specify an AvailabilitySet.</p>
<p>When specifying the role we provide an image the VM should be created with. Here is the helper function GetOsVirtualHardDisk:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> OSVirtualHardDisk <span class="title">GetOsVirtualHardDisk</span>(VirtualMachine virtualMachine)</div><div class="line">{</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OSVirtualHardDisk {</div><div class="line">        MediaLink = <span class="keyword">new</span> Uri(<span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, StorageUrl, virtualMachine.StorageAccount, virtualMachine.StoragePath)),</div><div class="line">        SourceImageName = virtualMachine.ImageName</div><div class="line">    };</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Here we refer to a standard image (ie b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04-LTS-amd64-server-20140618.1-en-us-30GB).</p>
<p>To deploy the docker host we need to specify a resource extension. This is what is covered in the CreateResourceExtensions method. Perhaps it may also be useful to see the json that is specified for this method</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">"resourceExtensions": [</div><div class="line">    {</div><div class="line">        "name": "DockerExtension",</div><div class="line">        "publisher": "MSOpenTech.Extensions",</div><div class="line">        "referenceName": "DockerExtension",</div><div class="line">        "version": "0.3",</div><div class="line">        "state": "enable",</div><div class="line">        "useConfigurator": true,</div><div class="line">        "resourceExtensionParameterValues": [</div><div class="line">            {</div><div class="line">                "key": "certificateDirectory",</div><div class="line">                "value": "{certificateDirectory}"</div><div class="line">            },</div><div class="line">            {</div><div class="line">                "key": "dockerPort",</div><div class="line">                "value": "4243"</div><div class="line">            }</div><div class="line">        ]</div><div class="line">    }</div><div class="line">],</div></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> IList&lt;ResourceExtensionReference&gt; <span class="title">CreateResourceExtensions</span>(</div><div class="line">    IEnumerable&lt;ResourceExtensionReferenceSettings&gt; referenceSettings)</div><div class="line">{</div><div class="line">    List&lt;ResourceExtensionReference&gt; references = <span class="keyword">new</span> List&lt;ResourceExtensionReference&gt;();</div><div class="line">    <span class="keyword">foreach</span> (ResourceExtensionReferenceSettings settings <span class="keyword">in</span> referenceSettings)</div><div class="line">    {</div><div class="line">        IList&lt;ResourceExtensionParameterValue&gt; resourceExtensionParameterValues;</div><div class="line">        <span class="keyword">if</span> (!settings.UseConfigurator)</div><div class="line">        {</div><div class="line">            resourceExtensionParameterValues =</div><div class="line">                settings.ResourceExtensionParameterValues.Select(</div><div class="line">                    values =&gt;</div><div class="line">                    <span class="keyword">new</span> ResourceExtensionParameterValue</div><div class="line">                        {</div><div class="line">                            Key = values.Key,</div><div class="line">                            Type = values.Type,</div><div class="line">                            Value = values.Value</div><div class="line">                        }).ToList();</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span></div><div class="line">        {</div><div class="line">            <span class="keyword">bool</span> hasConfigurator = ResourceExtensionConfigurators.ContainsKey(settings.Name);</div><div class="line">            <span class="keyword">if</span> (!hasConfigurator)</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                    <span class="keyword">string</span>.Format(</div><div class="line">                        CultureInfo.InvariantCulture,</div><div class="line">                        <span class="string">"Unknown resource extension {0} - found no registered configurator. Cannot continue."</span>,</div><div class="line">                        settings.Name));</div><div class="line">            }</div><div class="line"></div><div class="line">            resourceExtensionParameterValues =</div><div class="line">                ResourceExtensionConfigurators[settings.Name](settings.ResourceExtensionParameterValues);</div><div class="line">        }</div><div class="line"></div><div class="line">        ResourceExtensionReference reference = <span class="keyword">new</span> ResourceExtensionReference</div><div class="line">                {</div><div class="line">                    Name = settings.Name,</div><div class="line">                    Publisher = settings.Publisher,</div><div class="line">                    ReferenceName = settings.ReferenceName,</div><div class="line">                    State = settings.State,</div><div class="line">                    Version = settings.Version,</div><div class="line">                    ResourceExtensionParameterValues = resourceExtensionParameterValues</div><div class="line"></div><div class="line">                };</div><div class="line">        references.Add(reference);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> references;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>The net result is that we need to specify an ResourceExtensionReference instance for docker where,</p>
<ul>
<li>the Name is “DockerExtension”</li>
<li>Publisher is “MSOpenTech.Extensions”</li>
<li>ReferenceName is “DockerExtension”</li>
<li>and a version eg. “0.3” and two sets of key-value parameters<br>— one is key = “dockerPort” with eg value = “4243”<br>— and then the certificates to secure docker</li>
</ul>
<p>As you can see from the code above we have a configurator configuration for parameters that requires special handling. So to configure the docker resource extension we use this configurator.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> DockerExtensionConfigurator</div><div class="line">{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> CertificateDirectoryParameterName = <span class="string">"certificateDirectory"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> DockerPortParameterName = <span class="string">"dockerPort"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ParameterNotFound = <span class="string">"Resource extension parameter {0} must be specified"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> FileNotFound = <span class="string">"File {0} not found"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> CaCertFileName = <span class="string">"ca.pem"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ServerCertFileName = <span class="string">"server-cert.pem"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> ServerKeyFileName = <span class="string">"server-key.pem"</span>;</div><div class="line"></div><div class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="xmlDocTag">///</span> Configure docker extension</span></div><div class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IList&lt;ResourceExtensionParameterValue&gt; <span class="title">Configure</span>(</div><div class="line">        ICollection&lt;ResourceExtensionParameterValueSettings&gt; parameters)</div><div class="line">    {</div><div class="line">        List&lt;ResourceExtensionParameterValue&gt; convertedParameters = <span class="keyword">new</span> List&lt;ResourceExtensionParameterValue&gt;();</div><div class="line"></div><div class="line">        ResourceExtensionParameterValue certificates = GetCertificates(parameters);</div><div class="line">        ResourceExtensionParameterValue dockerPort = GetDockerPort(parameters);</div><div class="line">        convertedParameters.Add(certificates);</div><div class="line">        convertedParameters.Add(dockerPort);</div><div class="line">        <span class="keyword">return</span> convertedParameters;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ResourceExtensionParameterValue <span class="title">GetDockerPort</span>(IEnumerable&lt;ResourceExtensionParameterValueSettings&gt; parameters)</div><div class="line">    {</div><div class="line">        ResourceExtensionParameterValueSettings dockerPort =</div><div class="line">            parameters.FirstOrDefault(parameter =&gt; parameter.Key == DockerPortParameterName);</div><div class="line">        <span class="keyword">if</span> (dockerPort == <span class="keyword">null</span> || <span class="keyword">string</span>.IsNullOrWhiteSpace(dockerPort.Value))</div><div class="line">        {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, ParameterNotFound, DockerPortParameterName));</div><div class="line">        }</div><div class="line">        JObject <span class="keyword">value</span> = <span class="keyword">new</span> JObject(<span class="keyword">new</span> JProperty(<span class="string">"dockerport"</span>, dockerPort.Value));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResourceExtensionParameterValue {</div><div class="line">            Type = <span class="string">"Public"</span>,</div><div class="line">            Key = <span class="string">"ignored"</span>,</div><div class="line">            Value = <span class="keyword">value</span>.ToString(Formatting.None)</div><div class="line">        };</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ResourceExtensionParameterValue <span class="title">GetCertificates</span>(IEnumerable&lt;ResourceExtensionParameterValueSettings&gt; parameters)</div><div class="line">    {</div><div class="line">        ResourceExtensionParameterValueSettings certificateDirectory =</div><div class="line">            parameters.FirstOrDefault(parameter =&gt; parameter.Key == CertificateDirectoryParameterName);</div><div class="line">        <span class="keyword">if</span> (certificateDirectory == <span class="keyword">null</span> || <span class="keyword">string</span>.IsNullOrWhiteSpace(certificateDirectory.Value))</div><div class="line">        {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, ParameterNotFound, CertificateDirectoryParameterName));</div><div class="line">        }</div><div class="line">        <span class="keyword">string</span> caFileName = Path.Combine(certificateDirectory.Value, CaCertFileName);</div><div class="line">        <span class="keyword">string</span> serverCertFileName = Path.Combine(certificateDirectory.Value, ServerCertFileName);</div><div class="line">        <span class="keyword">string</span> serverKeyFileName = Path.Combine(certificateDirectory.Value, ServerKeyFileName);</div><div class="line"></div><div class="line">        CheckFileExists(caFileName);</div><div class="line">        CheckFileExists(serverCertFileName);</div><div class="line">        CheckFileExists(serverKeyFileName);</div><div class="line"></div><div class="line">        JObject <span class="keyword">value</span> = <span class="keyword">new</span> JObject(</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"ca"</span>, GetFileAsBase64(caFileName)),</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"server-cert"</span>, GetFileAsBase64(serverCertFileName)),</div><div class="line">            <span class="keyword">new</span> JProperty(<span class="string">"server-key"</span>, GetFileAsBase64(serverKeyFileName)));</div><div class="line"></div><div class="line">        ResourceExtensionParameterValue certificates = <span class="keyword">new</span> ResourceExtensionParameterValue</div><div class="line">            {</div><div class="line">                Key = <span class="string">"ignored"</span>,</div><div class="line">                Value = <span class="keyword">value</span>.ToString(Formatting.None),</div><div class="line">                Type = <span class="string">"Private"</span></div><div class="line">            };</div><div class="line">        <span class="keyword">return</span> certificates;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetFileAsBase64</span>(<span class="keyword">string</span> fileName)</div><div class="line">    {</div><div class="line">        <span class="keyword">return</span> Convert.ToBase64String(File.ReadAllBytes(fileName));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckFileExists</span>(<span class="keyword">string</span> fileName)</div><div class="line">    {</div><div class="line">        <span class="keyword">if</span> (!File.Exists(fileName))</div><div class="line">        {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(</div><div class="line">                <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, FileNotFound, fileName),</div><div class="line">                fileName);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Basically the certificate part is just a question of providing a json value with base64 encodings for the certificates.</p>
<p>Back to CreateRole besides creating data disks which is just providing a list of DataVirtualHardDisk instances. Then the roles ConfigurationSets must be specified. This is done in</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ConfigureMachine(virtualMachine, role.ConfigurationSets);</div><div class="line">ConfigureNetwork(virtualMachine.NetworkConfiguration, role.ConfigurationSets);</div><div class="line">...</div></pre></td></tr></table></figure>

<p>This first one configures the user name, password, hostname, timezone etc.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureMachine</span>(VirtualMachine virtualMachine, IList&lt;ConfigurationSet&gt; configurationSets)</div><div class="line">{</div><div class="line">    ConfigurationSet machineConfiguration = <span class="keyword">new</span> ConfigurationSet</div><div class="line">                                                {</div><div class="line">                                                    ResetPasswordOnFirstLogon = <span class="keyword">false</span>,</div><div class="line">                                                    EnableAutomaticUpdates = <span class="keyword">false</span>,</div><div class="line">                                                    ComputerName = virtualMachine.Name,</div><div class="line">                                                    AdminUserName = virtualMachine.AdminUserName,</div><div class="line">                                                    AdminPassword = virtualMachine.AdminPassword,</div><div class="line">                                                    HostName = virtualMachine.Name,</div><div class="line">                                                    SubnetNames = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(),</div><div class="line">                                                };</div><div class="line">    configurationSets.Add(machineConfiguration);</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(virtualMachine.Timezone))</div><div class="line">    {</div><div class="line">        machineConfiguration.TimeZone = virtualMachine.Timezone;</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (virtualMachine.Type.ToLowerInvariant() == WindowsProvisioningConfiguration)</div><div class="line">    {</div><div class="line">      ...</div><div class="line">    }</div><div class="line">    <span class="keyword">else</span></div><div class="line">    {</div><div class="line">        machineConfiguration.ConfigurationSetType = ConfigurationSetTypes.LinuxProvisioningConfiguration;</div><div class="line">        machineConfiguration.DisableSshPasswordAuthentication = <span class="keyword">false</span>;</div><div class="line">        machineConfiguration.UserName = virtualMachine.AdminUserName;</div><div class="line">        machineConfiguration.UserPassword = virtualMachine.AdminPassword;</div><div class="line">        <span class="keyword">if</span> (virtualMachine.Ssh != <span class="keyword">null</span>)</div><div class="line">        {</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(virtualMachine.Ssh.CertificateFile)</div><div class="line">                || !File.Exists(virtualMachine.Ssh.CertificateFile))</div><div class="line">            {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"SSH certificate file does not exist or is not specified"</span>);</div><div class="line">            }</div><div class="line">            machineConfiguration.SshSettings =</div><div class="line">                <span class="keyword">new</span> Microsoft.WindowsAzure.Management.Compute.Models.SshSettings();</div><div class="line">            machineConfiguration.DisableSshPasswordAuthentication = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            X509Certificate2 certificate = <span class="keyword">new</span> X509Certificate2();</div><div class="line">            certificate.Import(virtualMachine.Ssh.CertificateFile);</div><div class="line">            machineConfiguration.SshSettings.PublicKeys.Add(</div><div class="line">                <span class="keyword">new</span> SshSettingPublicKey(</div><div class="line">                    certificate.Thumbprint,</div><div class="line">                    <span class="keyword">string</span>.Format(CultureInfo.InvariantCulture, <span class="string">"//home/{0}//.ssh//authorized_keys"</span>, virtualMachine.AdminUserName)));</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>If we have specified ssh in the configuration then we refer to the previously uploaded certificate. Then for the network,</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureNetwork</span>(VirtualMachineNetworkConfiguration network, IList&lt;ConfigurationSet&gt; configurationSets)</div><div class="line">{</div><div class="line">    ConfigurationSet networkConfiguration = <span class="keyword">new</span> ConfigurationSet {</div><div class="line">        ConfigurationSetType = ConfigurationSetTypes.NetworkConfiguration,</div><div class="line">        SubnetNames = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;()</div><div class="line">    };</div><div class="line">    configurationSets.Add(networkConfiguration);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(network.Ip))</div><div class="line">    {</div><div class="line">        networkConfiguration.StaticVirtualNetworkIPAddress = network.Ip;</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (network.SubnetNames != <span class="keyword">null</span>)</div><div class="line">    {</div><div class="line">        List&lt;<span class="keyword">string</span>&gt; names = network.SubnetNames.ToList();</div><div class="line">        networkConfiguration.SubnetNames = names;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (network.Endpoints != <span class="keyword">null</span>)</div><div class="line">    {</div><div class="line">        <span class="keyword">foreach</span> (EndpointSetting endpoint <span class="keyword">in</span> network.Endpoints)</div><div class="line">        {</div><div class="line">            InputEndpoint inputEndpoint = <span class="keyword">new</span> InputEndpoint {</div><div class="line">                Port = endpoint.Port,</div><div class="line">                LocalPort = endpoint.LocalPort,</div><div class="line">                EnableDirectServerReturn = endpoint.EnableDirectServerReturn,</div><div class="line">                Protocol = endpoint.Protocol</div><div class="line">            };</div><div class="line">            <span class="keyword">if</span> (endpoint.AclRules != <span class="keyword">null</span>)</div><div class="line">            {</div><div class="line">                inputEndpoint.EndpointAcl = <span class="keyword">new</span> EndpointAcl {</div><div class="line">                    Rules = endpoint.AclRules.Select(rule =&gt;</div><div class="line">                        <span class="keyword">new</span> AccessControlListRule {</div><div class="line">                            Action = rule.Action,</div><div class="line">                            Description = rule.Description,</div><div class="line">                            Order = rule.Order,</div><div class="line">                            RemoteSubnet = rule.RemoteSubnet}).ToList()</div><div class="line">                };</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.Name))</div><div class="line">            {</div><div class="line">                inputEndpoint.Name = endpoint.Name;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.LoadBalancedEndpointSetName))</div><div class="line">            {</div><div class="line">                inputEndpoint.LoadBalancedEndpointSetName = endpoint.LoadBalancedEndpointSetName;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(endpoint.LoadBalancerName))</div><div class="line">            {</div><div class="line">                inputEndpoint.LoadBalancerName = endpoint.LoadBalancerName;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (endpoint.LoadBalancerProbe != <span class="keyword">null</span>)</div><div class="line">            {</div><div class="line">                inputEndpoint.LoadBalancerProbe =</div><div class="line">                    <span class="keyword">new</span> Microsoft.WindowsAzure.Management.Compute.Models.LoadBalancerProbe {</div><div class="line">                        IntervalInSeconds = endpoint.LoadBalancerProbe.IntervalInSeconds,</div><div class="line">                        Path = endpoint.LoadBalancerProbe.Path,</div><div class="line">                        Port = endpoint.LoadBalancerProbe.Port,</div><div class="line">                        Protocol = endpoint.LoadBalancerProbe.Protocol == <span class="string">"http"</span> ? LoadBalancerProbeTransportProtocol.Http : LoadBalancerProbeTransportProtocol.Tcp,</div><div class="line">                        TimeoutInSeconds = endpoint.LoadBalancerProbe.TimeoutInSeconds</div><div class="line">                    };</div><div class="line">            }</div><div class="line">            networkConfiguration.InputEndpoints.Add(inputEndpoint);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Here we setup the subnet, ip, endpoints - with endpoint security and possibly load balancer with a probe.</p>
<h2 id="The_End">The End</h2>
<p>That is basically what we did for the Azure part. The docker container deployment is another story.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.codeplayground.org/2015/03/04/azure-automation/" data-id="f4ohyng9203pdgu1" class="article-share-link">Share</a>
      
        <a href="http://blog.codeplayground.org/2015/03/04/azure-automation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure/" style="font-size: NaNpx;">Azure</a><a href="/tags/Docker/" style="font-size: NaNpx;">Docker</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/03/04/azure-automation/">Automate VM deployment with Azure + Docker</a>
          </li>
        
          <li>
            <a href="/2015/02/17/idea-behind-this-blog/">Idea behind this blog</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Mikael Kühn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'codeplayground';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>